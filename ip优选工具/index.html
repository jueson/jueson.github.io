<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»¶è¿Ÿæµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Courier New", monospace;
            background: #000; color: #00ff00; min-height: 100vh;
            overflow-x: hidden; position: relative;
        }
        .matrix-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: -1;
        }
        @keyframes bg-pulse {
            0%, 100% { background: linear-gradient(45deg, #000 0%, #001100 50%, #000 100%); }
            50% { background: linear-gradient(45deg, #000 0%, #002200 50%, #000 100%); }
        }
        .matrix-rain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: transparent;
            z-index: -1;
            display: none;
        }
        @keyframes matrix-fall {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
        .matrix-code-rain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1;
            overflow: hidden;
            display: none;
        }
        .matrix-column {
            position: absolute; top: -100%; left: 0;
            color: #00ff00; font-family: "Courier New", monospace;
            font-size: 14px; line-height: 1.2;
            text-shadow: 0 0 5px #00ff00;
        }
        @keyframes matrix-drop {
            0% { top: -100%; opacity: 1; }
            10% { opacity: 1; }
            90% { opacity: 0.3; }
            100% { top: 100vh; opacity: 0; }
        }
        .matrix-column:nth-child(odd) {
            animation-duration: 12s;
            animation-delay: -2s;
        }
        .matrix-column:nth-child(even) {
            animation-duration: 18s;
            animation-delay: -5s;
        }
        .matrix-column:nth-child(3n) {
            animation-duration: 20s;
            animation-delay: -8s;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        .header { text-align: center; margin-bottom: 40px; }
        .title {
            font-size: 3.5rem; font-weight: bold;
            text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00;
            margin-bottom: 10px;
            position: relative;
            color: #00ff00;
        }
        @keyframes matrix-glow {
            from { text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00; }
            to { text-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00, 0 0 50px #00ff00; }
        }
        @keyframes matrix-pulse {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .subtitle { color: #00aa00; margin-bottom: 30px; font-size: 1.2rem; }
        .card {
            background: rgba(0, 20, 0, 0.9);
            border: 2px solid #00ff00;
            border-radius: 0; padding: 30px; margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5), inset 0 0 20px rgba(0, 255, 0, 0.1);
            position: relative;
            backdrop-filter: blur(10px);
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
        }
        @keyframes card-glow {
            0%, 100% { box-shadow: 0 0 30px rgba(0, 255, 0, 0.5), inset 0 0 20px rgba(0, 255, 0, 0.1); }
            50% { box-shadow: 0 0 40px rgba(0, 255, 0, 0.7), inset 0 0 30px rgba(0, 255, 0, 0.2); }
        }
        .card::before {
            content: ""; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: none;
            opacity: 0; pointer-events: none;
        }
        @keyframes scan-line {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .card-title {
            font-size: 1.8rem; margin-bottom: 20px;
            color: #00ff00; text-shadow: 0 0 5px #00ff00;
        }
        .client-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px; margin: 20px 0;
        }
        .client-btn {
            background: rgba(0, 20, 0, 0.8);
            border: 2px solid #00ff00;
            padding: 15px 20px; color: #00ff00;
            font-family: "Courier New", monospace; font-weight: bold;
            cursor: pointer; transition: all 0.4s ease;
            text-align: center; position: relative;
            overflow: hidden;
            text-shadow: 0 0 5px #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        .client-btn::before {
            content: ""; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,0,0.4), transparent);
            transition: left 0.6s ease;
        }
        .client-btn::after {
            content: ""; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(0,255,0,0.1) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .client-btn:hover::before { left: 100%; }
        .client-btn:hover::after { opacity: 1; }
        .client-btn:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 25px #00ff00, 0 0 35px rgba(0, 255, 0, 0.5);
            transform: translateY(-3px) scale(1.05);
            text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00;
        }
        .generate-btn {
            background: rgba(0, 255, 0, 0.15);
            border: 2px solid #00ff00; padding: 15px 30px;
            color: #00ff00; font-family: "Courier New", monospace;
            font-weight: bold; cursor: pointer;
            transition: all 0.4s ease; margin-right: 15px;
            text-shadow: 0 0 8px #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
            position: relative;
            overflow: hidden;
        }
        .generate-btn::before {
            content: ""; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,0,0.5), transparent);
            transition: left 0.8s ease;
        }
        .generate-btn:hover::before { left: 100%; }
        .generate-btn:hover {
            background: rgba(0, 255, 0, 0.4);
            box-shadow: 0 0 30px #00ff00, 0 0 40px rgba(0, 255, 0, 0.6);
            transform: translateY(-4px) scale(1.08);
            text-shadow: 0 0 15px #00ff00, 0 0 25px #00ff00;
        }
        .subscription-url {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00; padding: 15px;
            word-break: break-all; font-family: "Courier New", monospace;
            color: #00ff00; margin-top: 20px; display: none;
            box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.4), 0 0 20px rgba(0, 255, 0, 0.3);
            border-radius: 5px;
            position: relative;
            overflow-wrap: break-word;
            overflow-x: auto;
            max-width: 100%;
            box-sizing: border-box;
        }
        @keyframes url-glow {
            from { box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.4), 0 0 20px rgba(0, 255, 0, 0.3); }
            to { box-shadow: inset 0 0 20px rgba(0, 255, 0, 0.6), 0 0 30px rgba(0, 255, 0, 0.5); }
        }
        .subscription-url::before {
            content: ""; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%;
            background: none;
        }
        @keyframes url-scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»¶è¿Ÿæµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Courier New", monospace;
            background: #000; color: #00ff00; min-height: 100vh;
            overflow-x: hidden; position: relative;
        }
        .matrix-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: -1;
        }
        @keyframes bg-pulse {
            0%, 100% { background: linear-gradient(45deg, #000 0%, #001100 50%, #000 100%); }
            50% { background: linear-gradient(45deg, #000 0%, #002200 50%, #000 100%); }
        }
        .matrix-rain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: transparent;
            z-index: -1;
            display: none;
        }
        @keyframes matrix-fall {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
        .matrix-code-rain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1;
            overflow: hidden;
            display: none;
        }
        .matrix-column {
            position: absolute; top: -100%; left: 0;
            color: #00ff00; font-family: "Courier New", monospace;
            font-size: 14px; line-height: 1.2;
            text-shadow: 0 0 5px #00ff00;
        }
        @keyframes matrix-drop {
            0% { top: -100%; opacity: 1; }
            10% { opacity: 1; }
            90% { opacity: 0.3; }
            100% { top: 100vh; opacity: 0; }
        }
        .matrix-column:nth-child(odd) {
            animation-duration: 12s;
            animation-delay: -2s;
        }
        .matrix-column:nth-child(even) {
            animation-duration: 18s;
            animation-delay: -5s;
        }
        .matrix-column:nth-child(3n) {
            animation-duration: 20s;
            animation-delay: -8s;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        .header { text-align: center; margin-bottom: 40px; }
        .title {
            font-size: 3.5rem; font-weight: bold;
            text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00;
            margin-bottom: 10px;
            position: relative;
            color: #00ff00;
        }
        @keyframes matrix-glow {
            from { text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00; }
            to { text-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00, 0 0 50px #00ff00; }
        }
        @keyframes matrix-pulse {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .subtitle { color: #00aa00; margin-bottom: 30px; font-size: 1.2rem; }
        .card {
            background: rgba(0, 20, 0, 0.9);
            border: 2px solid #00ff00;
            border-radius: 0; padding: 30px; margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5), inset 0 0 20px rgba(0, 255, 0, 0.1);
            position: relative;
            backdrop-filter: blur(10px);
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
        }
        @keyframes card-glow {
            0%, 100% { box-shadow: 0 0 30px rgba(0, 255, 0, 0.5), inset 0 0 20px rgba(0, 255, 0, 0.1); }
            50% { box-shadow: 0 0 40px rgba(0, 255, 0, 0.7), inset 0 0 30px rgba(0, 255, 0, 0.2); }
        }
        .card::before {
            content: ""; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: none;
            opacity: 0; pointer-events: none;
        }
        @keyframes scan-line {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .card-title {
            font-size: 1.8rem; margin-bottom: 20px;
            color: #00ff00; text-shadow: 0 0 5px #00ff00;
        }
        .client-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px; margin: 20px 0;
        }
        .client-btn {
            background: rgba(0, 20, 0, 0.8);
            border: 2px solid #00ff00;
            padding: 15px 20px; color: #00ff00;
            font-family: "Courier New", monospace; font-weight: bold;
            cursor: pointer; transition: all 0.4s ease;
            text-align: center; position: relative;
            overflow: hidden;
            text-shadow: 0 0 5px #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        .client-btn::before {
            content: ""; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,0,0.4), transparent);
            transition: left 0.6s ease;
        }
        .client-btn::after {
            content: ""; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(0,255,0,0.1) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .client-btn:hover::before { left: 100%; }
        .client-btn:hover::after { opacity: 1; }
        .client-btn:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 25px #00ff00, 0 0 35px rgba(0, 255, 0, 0.5);
            transform: translateY(-3px) scale(1.05);
            text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00;
        }
        .generate-btn {
            background: rgba(0, 255, 0, 0.15);
            border: 2px solid #00ff00; padding: 15px 30px;
            color: #00ff00; font-family: "Courier New", monospace;
            font-weight: bold; cursor: pointer;
            transition: all 0.4s ease; margin-right: 15px;
            text-shadow: 0 0 8px #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
            position: relative;
            overflow: hidden;
        }
        .generate-btn::before {
            content: ""; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,0,0.5), transparent);
            transition: left 0.8s ease;
        }
        .generate-btn:hover::before { left: 100%; }
        .generate-btn:hover {
            background: rgba(0, 255, 0, 0.4);
            box-shadow: 0 0 30px #00ff00, 0 0 40px rgba(0, 255, 0, 0.6);
            transform: translateY(-4px) scale(1.08);
            text-shadow: 0 0 15px #00ff00, 0 0 25px #00ff00;
        }
        .subscription-url {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00; padding: 15px;
            word-break: break-all; font-family: "Courier New", monospace;
            color: #00ff00; margin-top: 20px; display: none;
            box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.4), 0 0 20px rgba(0, 255, 0, 0.3);
            border-radius: 5px;
            position: relative;
            overflow-wrap: break-word;
            overflow-x: auto;
            max-width: 100%;
            box-sizing: border-box;
        }
        @keyframes url-glow {
            from { box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.4), 0 0 20px rgba(0, 255, 0, 0.3); }
            to { box-shadow: inset 0 0 20px rgba(0, 255, 0, 0.6), 0 0 30px rgba(0, 255, 0, 0.5); }
        }
        .subscription-url::before {
            content: ""; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%;
            background: none;
        }
        @keyframes url-scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .matrix-text {
            position: fixed; top: 20px; right: 20px;
            color: #00ff00; font-family: "Courier New", monospace;
            font-size: 0.8rem; opacity: 0.6;
        }
        @keyframes matrix-flicker {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="matrix-bg"></div>
    <div class="matrix-rain"></div>
    <div class="matrix-code-rain" id="matrixCodeRain"></div>
    
    <div class="container">
        <div class="header">
            <h1 class="title">å»¶è¿Ÿæµ‹è¯•</h1>
            
        </div>
        <div class="card">
                            <h4 style="color: #00ff00; margin: 0 0 15px 0; font-size: 1.1rem; text-shadow: 0 0 5px #00ff00;">âš¡ å»¶è¿Ÿæµ‹è¯•</h4>
                            <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
                                <div style="min-width: 120px;">
                                    <label style="display: block; margin-bottom: 5px; color: #00ff00; font-size: 0.9rem;">IPæ¥æº:</label>
                                    <select id="ipSourceSelect" style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.8); border: 1px solid #00ff00; color: #00ff00; font-family: 'Courier New', monospace; font-size: 13px; cursor: pointer;">
                                        <option value="manual">æ‰‹åŠ¨è¾“å…¥</option>
                                        <option value="cfRandom">CFéšæœºIP</option>
                                        <option value="urlFetch">URLè·å–</option>
                                    </select>
                                </div>
                                <div style="width: 100px;">
                                    <label style="display: block; margin-bottom: 5px; color: #00ff00; font-size: 0.9rem;">ç«¯å£:</label>
                                    <input type="number" id="latencyTestPort" value="443" min="1" max="65535" style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.8); border: 1px solid #00ff00; color: #00ff00; font-family: 'Courier New', monospace; font-size: 13px;">
                                </div>
                                <div id="randomCountDiv" style="width: 100px; display: none;">
                                    <label style="display: block; margin-bottom: 5px; color: #00ff00; font-size: 0.9rem;">ç”Ÿæˆæ•°é‡:</label>
                                    <input type="number" id="randomIPCount" value="20" min="1" max="100" style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.8); border: 1px solid #00ff00; color: #00ff00; font-family: 'Courier New', monospace; font-size: 13px;">
                                </div>
                                <div style="width: 80px;">
                                    <label style="display: block; margin-bottom: 5px; color: #00ff00; font-size: 0.9rem;">çº¿ç¨‹</label>
                                    <input type="number" id="testThreads" value="5" min="1" max="50" style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.8); border: 1px solid #00ff00; color: #00ff00; font-family: 'Courier New', monospace; font-size: 13px;">
                                </div>
                            </div>
                            <div id="manualInputDiv" style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; color: #00ff00; font-size: 0.9rem;">æµ‹è¯•IP/åŸŸå:</label>
                                <input type="text" id="latencyTestInput" placeholder="è¾“å…¥IPæˆ–åŸŸåï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”" style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.8); border: 1px solid #00ff00; color: #00ff00; font-family: 'Courier New', monospace; font-size: 13px;">
                            </div>
                            <div id="urlFetchDiv" style="margin-bottom: 10px; display: none;">
                                <label style="display: block; margin-bottom: 5px; color: #00ff00; font-size: 0.9rem;">è·å–URL:</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" id="fetchURLInput" placeholder="è¾“å…¥ä¼˜é€‰IPçš„URLåœ°å€" style="flex: 1; padding: 10px; background: rgba(0, 0, 0, 0.8); border: 1px solid #00ff00; color: #00ff00; font-family: 'Courier New', monospace; font-size: 13px;">
                                    <button type="button" id="fetchIPBtn" style="background: rgba(0, 200, 255, 0.2); border: 1px solid #00aaff; padding: 8px 16px; color: #00aaff; font-family: 'Courier New', monospace; cursor: pointer; white-space: nowrap;">â¬‡ è·å–IP</button>
                                </div>
                            </div>
                            <div id="cfRandomDiv" style="margin-bottom: 10px; display: none;">
                                <button type="button" id="generateCFIPBtn" style="background: rgba(0, 255, 0, 0.15); border: 1px solid #00ff00; padding: 10px 20px; color: #00ff00; font-family: 'Courier New', monospace; cursor: pointer; width: 100%; transition: all 0.3s;">ğŸ² ç”ŸæˆIP</button>
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button type="button" id="startLatencyTest" style="background: rgba(0, 255, 0, 0.2); border: 1px solid #00ff00; padding: 8px 16px; color: #00ff00; font-family: 'Courier New', monospace; cursor: pointer; transition: all 0.3s;">â–¶ å¼€å§‹æµ‹è¯•</button>
                                <button type="button" id="stopLatencyTest" style="background: rgba(255, 0, 0, 0.2); border: 1px solid #ff4444; padding: 8px 16px; color: #ff4444; font-family: 'Courier New', monospace; cursor: pointer; display: none; transition: all 0.3s;">â¹ åœæ­¢æµ‹è¯•</button>
                            </div>
                            <div id="latencyTestStatus" style="color: #00aa00; font-size: 0.9rem; margin-bottom: 10px; display: none;"></div>
                            <div id="latencyTestResults" style="max-height: 250px; overflow-y: auto; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="color: #00ff00; font-weight: bold;">æµ‹è¯•ç»“æœ:</span>
                                    <div style="display: flex; gap: 8px;">
                                        <button type="button" id="selectAllResults" style="background: transparent; border: 1px solid #00aa00; padding: 4px 10px; color: #00aa00; font-size: 0.8rem; cursor: pointer;">å…¨é€‰</button>
                                        <button type="button" id="deselectAllResults" style="background: transparent; border: 1px solid #00aa00; padding: 4px 10px; color: #00aa00; font-size: 0.8rem; cursor: pointer;">å–æ¶ˆå…¨é€‰</button>
                                    </div>
                                </div>
                                <div id="cityFilterContainer" style="margin-bottom: 10px; padding: 10px; background: rgba(0, 20, 0, 0.6); border: 1px solid #00aa00; border-radius: 4px; display: none;">
                                    <div style="margin-bottom: 8px;">
                                        <label style="display: inline-flex; align-items: center; cursor: pointer; color: #00ff00; font-size: 0.9rem;">
                                            <input type="radio" name="cityFilterMode" value="all" checked style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                                            <span>å…¨éƒ¨åŸå¸‚</span>
                                        </label>
                                        <label style="display: inline-flex; align-items: center; cursor: pointer; color: #00ff00; font-size: 0.9rem; margin-left: 15px;">
                                            <input type="radio" name="cityFilterMode" value="fastest10" style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                                            <span>åªé€‰æ‹©æœ€å¿«çš„10ä¸ª</span>
                                        </label>
                                    </div>
                                    <div id="cityCheckboxesContainer" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 80px; overflow-y: auto; padding: 5px;"></div>
                                </div>
                                <div id="latencyResultsList" style="background: rgba(0, 0, 0, 0.5); border: 1px solid #004400; border-radius: 4px; padding: 10px;"></div>
<<div style="margin-top: 10px; display: flex; gap: 10px;">
    <button type="button" id="downloadOverwriteBtn" style="flex: 1; background: rgba(0, 100, 255, 0.3); border: 1px solid #0066ff; padding: 10px 20px; color: #0066ff; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.3s;">ä¸‹è½½é€‰ä¸­é¡¹</button>
</div>
                            </div>
        </div>
        <script>
            // è®¢é˜…è½¬æ¢åœ°å€ï¼ˆä»æœåŠ¡å™¨é…ç½®æ³¨å…¥ï¼‰
            var SUB_CONVERTER_URL = "https://url.v1.mk/sub";
            // è¿œç¨‹é…ç½®URLï¼ˆç¡¬ç¼–ç ï¼‰
            var REMOTE_CONFIG_URL = "https://raw.githubusercontent.com/byJoey/test/refs/heads/main/tist.ini";

                // ç¿»è¯‘å¯¹è±¡
                const translations = {
                    zh: {
                        subscriptionCopied: 'è®¢é˜…é“¾æ¥å·²å¤åˆ¶',
                        autoSubscriptionCopied: 'è‡ªåŠ¨è¯†åˆ«è®¢é˜…é“¾æ¥å·²å¤åˆ¶ï¼Œå®¢æˆ·ç«¯è®¿é—®æ—¶ä¼šæ ¹æ®User-Agentè‡ªåŠ¨è¯†åˆ«å¹¶è¿”å›å¯¹åº”æ ¼å¼'
                    },
                    fa: {
                        subscriptionCopied: 'Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú© Ú©Ù¾ÛŒ Ø´Ø¯',
                        autoSubscriptionCopied: 'Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú© ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø± Ú©Ù¾ÛŒ Ø´Ø¯ØŒ Ú©Ù„Ø§ÛŒÙ†Øª Ù‡Ù†Ú¯Ø§Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ User-Agent Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ùˆ Ù‚Ø§Ù„Ø¨ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯'
                    }
                };

                function getCookie(name) {
                    const value = '; ' + document.cookie;
                    const parts = value.split('; ' + name + '=');
                    if (parts.length === 2) return parts.pop().split(';').shift();
                    return null;
                }

                const browserLang = navigator.language || navigator.userLanguage || '';
                const savedLang = localStorage.getItem('preferredLanguage') || getCookie('preferredLanguage');
                let isFarsi = false;

                if (savedLang === 'fa' || savedLang === 'fa-IR') {
                    isFarsi = true;
                } else if (savedLang === 'zh' || savedLang === 'zh-CN') {
                    isFarsi = false;
                } else {
                    isFarsi = browserLang.includes('fa') || browserLang.includes('fa-IR');
                }

                const t = translations[isFarsi ? 'fa' : 'zh'];

                function changeLanguage(lang) {
                    localStorage.setItem('preferredLanguage', lang);
                    // è®¾ç½®Cookieï¼ˆæœ‰æ•ˆæœŸ1å¹´ï¼‰
                    const expiryDate = new Date();
                    expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                    document.cookie = 'preferredLanguage=' + lang + '; path=/; expires=' + expiryDate.toUTCString() + '; SameSite=Lax';
                    // åˆ·æ–°é¡µé¢ï¼Œä¸ä½¿ç”¨URLå‚æ•°
                    window.location.reload();
                }

                // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ localStorage å’Œ Cookieï¼Œå¹¶æ¸…ç†URLå‚æ•°
                window.addEventListener('DOMContentLoaded', function() {
                    const savedLang = localStorage.getItem('preferredLanguage') || getCookie('preferredLanguage');
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlLang = urlParams.get('lang');

                    // å¦‚æœURLä¸­æœ‰è¯­è¨€å‚æ•°ï¼Œç§»é™¤å®ƒå¹¶è®¾ç½®Cookie
                    if (urlLang) {
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.delete('lang');
                        const newUrl = currentUrl.toString();

                        // è®¾ç½®Cookie
                        const expiryDate = new Date();
                        expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                        document.cookie = 'preferredLanguage=' + urlLang + '; path=/; expires=' + expiryDate.toUTCString() + '; SameSite=Lax';
                        localStorage.setItem('preferredLanguage', urlLang);

                        // ä½¿ç”¨history APIç§»é™¤URLå‚æ•°ï¼Œä¸åˆ·æ–°é¡µé¢
                        window.history.replaceState({}, '', newUrl);
                    } else if (savedLang) {
                        // å¦‚æœlocalStorageä¸­æœ‰ä½†Cookieä¸­æ²¡æœ‰ï¼ŒåŒæ­¥åˆ°Cookie
                        const expiryDate = new Date();
                        expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                        document.cookie = 'preferredLanguage=' + savedLang + '; path=/; expires=' + expiryDate.toUTCString() + '; SameSite=Lax';
                    }
                });

            function tryOpenApp(schemeUrl, fallbackCallback, timeout) {
                timeout = timeout || 2500;
                var appOpened = false;
                var callbackExecuted = false;
                var startTime = Date.now();

                var blurHandler = function() {
                    var elapsed = Date.now() - startTime;
                    if (elapsed < 3000 && !callbackExecuted) {
                        appOpened = true;
                    }
                };

                window.addEventListener('blur', blurHandler);

                var hiddenHandler = function() {
                    var elapsed = Date.now() - startTime;
                    if (elapsed < 3000 && !callbackExecuted) {
                        appOpened = true;
                    }
                };

                document.addEventListener('visibilitychange', hiddenHandler);

                var iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.style.width = '1px';
                iframe.style.height = '1px';
                iframe.src = schemeUrl;
                document.body.appendChild(iframe);

                setTimeout(function() {
                    iframe.parentNode && iframe.parentNode.removeChild(iframe);
                    window.removeEventListener('blur', blurHandler);
                    document.removeEventListener('visibilitychange', hiddenHandler);

                    if (!callbackExecuted) {
                        callbackExecuted = true;
                        if (!appOpened && fallbackCallback) {
                            fallbackCallback();
                        }
                    }
                }, timeout);
            }

            function generateClientLink(clientType, clientName) {
                var currentUrl = window.location.href;
                var subscriptionUrl = currentUrl + "/sub";
                var schemeUrl = '';
                var displayName = clientName || '';
                var finalUrl = subscriptionUrl;

                if (clientType === atob('djJyYXk=')) {
                    finalUrl = subscriptionUrl;
                    var urlElement = document.getElementById("clientSubscriptionUrl");
                    urlElement.textContent = finalUrl;
                    urlElement.style.display = "block";
                    urlElement.style.overflowWrap = "break-word";
                    urlElement.style.wordBreak = "break-all";
                    urlElement.style.overflowX = "auto";
                    urlElement.style.maxWidth = "100%";
                    urlElement.style.boxSizing = "border-box";

                    if (clientName === 'V2RAY') {
                        navigator.clipboard.writeText(finalUrl).then(function() {
                                alert(displayName + " " + t.subscriptionCopied);
                        });
                    } else if (clientName === 'Shadowrocket') {
                        schemeUrl = 'shadowrocket://add/' + encodeURIComponent(finalUrl);
                        tryOpenApp(schemeUrl, function() {
                            navigator.clipboard.writeText(finalUrl).then(function() {
                                    alert(displayName + " " + t.subscriptionCopied);
                            });
                        });
                    } else if (clientName === 'V2RAYNG') {
                        schemeUrl = 'v2rayng://install?url=' + encodeURIComponent(finalUrl);
                        tryOpenApp(schemeUrl, function() {
                            navigator.clipboard.writeText(finalUrl).then(function() {
                                    alert(displayName + " " + t.subscriptionCopied);
                            });
                        });
                    } else if (clientName === 'NEKORAY') {
                        schemeUrl = 'nekoray://install-config?url=' + encodeURIComponent(finalUrl);
                        tryOpenApp(schemeUrl, function() {
                            navigator.clipboard.writeText(finalUrl).then(function() {
                                    alert(displayName + " " + t.subscriptionCopied);
                            });
                        });
                    }
                } else {
                    // æ£€æŸ¥ ECH æ˜¯å¦å¼€å¯
                    var echEnabled = document.getElementById('ech') && document.getElementById('ech').checked;

                    // å¦‚æœ ECH å¼€å¯ä¸”æ˜¯ Clashï¼Œç›´æ¥ä½¿ç”¨åç«¯æ¥å£
                    if (echEnabled && clientType === atob('Y2xhc2g=')) {
                        finalUrl = subscriptionUrl + "?target=" + clientType;
                        var urlElement = document.getElementById("clientSubscriptionUrl");
                        urlElement.textContent = finalUrl;
                        urlElement.style.display = "block";
                        urlElement.style.overflowWrap = "break-word";
                        urlElement.style.wordBreak = "break-all";
                        urlElement.style.overflowX = "auto";
                        urlElement.style.maxWidth = "100%";
                        urlElement.style.boxSizing = "border-box";

                        if (clientName === 'STASH') {
                            schemeUrl = 'stash://install?url=' + encodeURIComponent(finalUrl);
                            displayName = 'STASH';
                        } else {
                            schemeUrl = 'clash://install-config?url=' + encodeURIComponent(finalUrl);
                            displayName = 'CLASH';
                        }

                        if (schemeUrl) {
                            tryOpenApp(schemeUrl, function() {
                                navigator.clipboard.writeText(finalUrl).then(function() {
                                        alert(displayName + " " + t.subscriptionCopied);
                                });
                            });
                        } else {
                            navigator.clipboard.writeText(finalUrl).then(function() {
                                    alert(displayName + " " + t.subscriptionCopied);
                            });
                        }
                    } else {
                        // å…¶ä»–æƒ…å†µä½¿ç”¨è®¢é˜…è½¬æ¢æœåŠ¡
                        var encodedUrl = encodeURIComponent(subscriptionUrl);
                        finalUrl = SUB_CONVERTER_URL + "?target=" + clientType + "&url=" + encodedUrl + "&insert=false&config=" + encodeURIComponent(REMOTE_CONFIG_URL) + "&emoji=true&list=false&xudp=false&udp=false&tfo=false&expand=true&scv=false&fdn=false&new_name=true";
                        var urlElement = document.getElementById("clientSubscriptionUrl");
                        urlElement.textContent = finalUrl;
                        urlElement.style.display = "block";
                        urlElement.style.overflowWrap = "break-word";
                        urlElement.style.wordBreak = "break-all";
                        urlElement.style.overflowX = "auto";
                        urlElement.style.maxWidth = "100%";
                        urlElement.style.boxSizing = "border-box";

                        if (clientType === atob('Y2xhc2g=')) {
                            if (clientName === 'STASH') {
                                schemeUrl = 'stash://install?url=' + encodeURIComponent(finalUrl);
                                displayName = 'STASH';
                            } else {
                                schemeUrl = 'clash://install-config?url=' + encodeURIComponent(finalUrl);
                                displayName = 'CLASH';
                            }
                        } else if (clientType === atob('c3VyZ2U=')) {
                            schemeUrl = 'surge:///install-config?url=' + encodeURIComponent(finalUrl);
                            displayName = 'SURGE';
                        } else if (clientType === atob('c2luZ2JveA==')) {
                            schemeUrl = 'sing-box://install-config?url=' + encodeURIComponent(finalUrl);
                            displayName = 'SING-BOX';
                        } else if (clientType === atob('bG9vbg==')) {
                            schemeUrl = 'loon://install?url=' + encodeURIComponent(finalUrl);
                            displayName = 'LOON';
                        } else if (clientType === atob('cXVhbng=')) {
                            schemeUrl = 'quantumult-x://install-config?url=' + encodeURIComponent(finalUrl);
                            displayName = 'QUANTUMULT X';
                        }

                        if (schemeUrl) {
                            tryOpenApp(schemeUrl, function() {
                                navigator.clipboard.writeText(finalUrl).then(function() {
                                        alert(displayName + " " + t.subscriptionCopied);
                                });
                            });
                        } else {
                            navigator.clipboard.writeText(finalUrl).then(function() {
                                    alert(displayName + " " + t.subscriptionCopied);
                            });
                        }
                    }
                }
            }

            function createMatrixRain() {
                const matrixContainer = document.getElementById('matrixCodeRain');
                const matrixChars = '01ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
                const columns = Math.floor(window.innerWidth / 18);

                for (let i = 0; i < columns; i++) {
                    const column = document.createElement('div');
                    column.className = 'matrix-column';
                    column.style.left = (i * 18) + 'px';
                    column.style.animationDelay = Math.random() * 15 + 's';
                    column.style.animationDuration = (Math.random() * 15 + 8) + 's';
                    column.style.fontSize = (Math.random() * 4 + 12) + 'px';
                    column.style.opacity = Math.random() * 0.8 + 0.2;

                    let text = '';
                    const charCount = Math.floor(Math.random() * 30 + 20);
                    for (let j = 0; j < charCount; j++) {
                        const char = matrixChars[Math.floor(Math.random() * matrixChars.length)];
                        const brightness = Math.random() > 0.1 ? '#00ff00' : '#00aa00';
                        text += '<span style="color: ' + brightness + ';">' + char + '</span><br>';
                    }
                    column.innerHTML = text;
                    matrixContainer.appendChild(column);
                }

                setInterval(function() {
                    const columns = matrixContainer.querySelectorAll('.matrix-column');
                    columns.forEach(function(column) {
                        if (Math.random() > 0.95) {
                            const chars = column.querySelectorAll('span');
                            if (chars.length > 0) {
                                const randomChar = chars[Math.floor(Math.random() * chars.length)];
                                randomChar.style.color = '#ffffff';
                                setTimeout(function() {
                                    randomChar.style.color = '#00ff00';
                                }, 200);
                            }
                        }
                    });
                }, 100);
            }

            async function checkSystemStatus() {
                try {
                    const cfStatus = document.getElementById('cfStatus');
                    const regionStatus = document.getElementById('regionStatus');
                    const geoInfo = document.getElementById('geoInfo');
                    const backupStatus = document.getElementById('backupStatus');
                    const currentIP = document.getElementById('currentIP');
                    const regionMatch = document.getElementById('regionMatch');

                        // è·å–å½“å‰è¯­è¨€è®¾ç½®ï¼ˆä¼˜å…ˆä»Cookie/localStorageè¯»å–ï¼‰
                        function getCookie(name) {
                            const value = '; ' + document.cookie;
                            const parts = value.split('; ' + name + '=');
                            if (parts.length === 2) return parts.pop().split(';').shift();
                            return null;
                        }

                        const browserLang = navigator.language || navigator.userLanguage || '';
                        const savedLang = localStorage.getItem('preferredLanguage') || getCookie('preferredLanguage');
                        let isFarsi = false;

                        if (savedLang === 'fa' || savedLang === 'fa-IR') {
                            isFarsi = true;
                        } else if (savedLang === 'zh' || savedLang === 'zh-CN') {
                            isFarsi = false;
                        } else {
                            isFarsi = browserLang.includes('fa') || browserLang.includes('fa-IR');
                        }

                        const translations = {
                            zh: {
                                workerRegion: 'Workeråœ°åŒº: ',
                                detectionMethod: 'æ£€æµ‹æ–¹å¼: ',
                                proxyIPStatus: 'ProxyIPçŠ¶æ€: ',
                                currentIP: 'å½“å‰ä½¿ç”¨IP: ',
                                regionMatch: 'åœ°åŒºåŒ¹é…: ',
                                regionNames: {
                        'US': 'ğŸ‡ºğŸ‡¸ ç¾å›½', 'SG': 'ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡', 'JP': 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬',
                        'KR': 'ğŸ‡°ğŸ‡· éŸ©å›½', 'DE': 'ğŸ‡©ğŸ‡ª å¾·å›½', 'SE': 'ğŸ‡¸ğŸ‡ª ç‘å…¸', 'NL': 'ğŸ‡³ğŸ‡± è·å…°',
                        'FI': 'ğŸ‡«ğŸ‡® èŠ¬å…°', 'GB': 'ğŸ‡¬ğŸ‡§ è‹±å›½'
                                },
                                customIPMode: 'è‡ªå®šä¹‰ProxyIPæ¨¡å¼ (på˜é‡å¯ç”¨)',
                                customIPModeDesc: 'è‡ªå®šä¹‰IPæ¨¡å¼ (å·²ç¦ç”¨åœ°åŒºåŒ¹é…)',
                                usingCustomProxyIP: 'ä½¿ç”¨è‡ªå®šä¹‰ProxyIP: ',
                                customIPConfig: ' (på˜é‡é…ç½®)',
                                customIPModeDisabled: 'è‡ªå®šä¹‰IPæ¨¡å¼ï¼Œåœ°åŒºé€‰æ‹©å·²ç¦ç”¨',
                                manualRegion: 'æ‰‹åŠ¨æŒ‡å®šåœ°åŒº',
                                manualRegionDesc: ' (æ‰‹åŠ¨æŒ‡å®š)',
                                proxyIPAvailable: '10/10 å¯ç”¨ (ProxyIPåŸŸåé¢„è®¾å¯ç”¨)',
                                smartSelection: 'æ™ºèƒ½å°±è¿‘é€‰æ‹©ä¸­',
                                sameRegionIP: 'åŒåœ°åŒºIPå¯ç”¨ (1ä¸ª)',
                                cloudflareDetection: 'Cloudflareå†…ç½®æ£€æµ‹',
                                detectionFailed: 'æ£€æµ‹å¤±è´¥',
                                unknown: 'æœªçŸ¥'
                            },
                            fa: {
                                workerRegion: 'Ù…Ù†Ø·Ù‚Ù‡ Worker: ',
                                detectionMethod: 'Ø±ÙˆØ´ ØªØ´Ø®ÛŒØµ: ',
                                proxyIPStatus: 'ÙˆØ¶Ø¹ÛŒØª ProxyIP: ',
                                currentIP: 'IP ÙØ¹Ù„ÛŒ: ',
                                regionMatch: 'ØªØ·Ø¨ÛŒÙ‚ Ù…Ù†Ø·Ù‚Ù‡: ',
                                regionNames: {
                                    'US': 'ğŸ‡ºğŸ‡¸ Ø¢Ù…Ø±ÛŒÚ©Ø§', 'SG': 'ğŸ‡¸ğŸ‡¬ Ø³Ù†Ú¯Ø§Ù¾ÙˆØ±', 'JP': 'ğŸ‡¯ğŸ‡µ Ú˜Ø§Ù¾Ù†',
                                    'KR': 'ğŸ‡°ğŸ‡· Ú©Ø±Ù‡ Ø¬Ù†ÙˆØ¨ÛŒ', 'DE': 'ğŸ‡©ğŸ‡ª Ø¢Ù„Ù…Ø§Ù†', 'SE': 'ğŸ‡¸ğŸ‡ª Ø³ÙˆØ¦Ø¯', 'NL': 'ğŸ‡³ğŸ‡± Ù‡Ù„Ù†Ø¯',
                                    'FI': 'ğŸ‡«ğŸ‡® ÙÙ†Ù„Ø§Ù†Ø¯', 'GB': 'ğŸ‡¬ğŸ‡§ Ø¨Ø±ÛŒØªØ§Ù†ÛŒØ§'
                                },
                                customIPMode: 'Ø­Ø§Ù„Øª ProxyIP Ø³ÙØ§Ø±Ø´ÛŒ (Ù…ØªØºÛŒØ± p ÙØ¹Ø§Ù„ Ø§Ø³Øª)',
                                customIPModeDesc: 'Ø­Ø§Ù„Øª IP Ø³ÙØ§Ø±Ø´ÛŒ (ØªØ·Ø¨ÛŒÙ‚ Ù…Ù†Ø·Ù‚Ù‡ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª)',
                                usingCustomProxyIP: 'Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ProxyIP Ø³ÙØ§Ø±Ø´ÛŒ: ',
                                customIPConfig: ' (Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù…ØªØºÛŒØ± p)',
                                customIPModeDisabled: 'Ø­Ø§Ù„Øª IP Ø³ÙØ§Ø±Ø´ÛŒØŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù†Ø·Ù‚Ù‡ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª',
                                manualRegion: 'ØªØ¹ÛŒÛŒÙ† Ù…Ù†Ø·Ù‚Ù‡ Ø¯Ø³ØªÛŒ',
                                manualRegionDesc: ' (ØªØ¹ÛŒÛŒÙ† Ø¯Ø³ØªÛŒ)',
                                proxyIPAvailable: '10/10 Ø¯Ø± Ø¯Ø³ØªØ±Ø³ (Ø¯Ø§Ù…Ù†Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ProxyIP Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª)',
                                smartSelection: 'Ø§Ù†ØªØ®Ø§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù†Ø²Ø¯ÛŒÚ© Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³Øª',
                                sameRegionIP: 'IP Ù‡Ù…â€ŒÙ…Ù†Ø·Ù‚Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª (1)',
                                cloudflareDetection: 'ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø®Ù„ÛŒ Cloudflare',
                                detectionFailed: 'ØªØ´Ø®ÛŒØµ Ù†Ø§Ù…ÙˆÙÙ‚',
                                unknown: 'Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'
                            }
                        };

                        const t = translations[isFarsi ? 'fa' : 'zh'];

                    let detectedRegion = 'US'; // é»˜è®¤å€¼
                    let isCustomIPMode = false;
                    let isManualRegionMode = false;
                    try {
                        const response = await fetch(window.location.pathname + '/region');
                        const data = await response.json();

                        if (data.region === 'CUSTOM') {
                            isCustomIPMode = true;
                            detectedRegion = 'CUSTOM';

                            // è·å–è‡ªå®šä¹‰IPçš„è¯¦ç»†ä¿¡æ¯
                                const customIPInfo = data.ci || t.unknown;

                                geoInfo.innerHTML = t.detectionMethod + '<span style="color: #ffaa00;">âš™ï¸ ' + t.customIPMode + '</span>';
                                regionStatus.innerHTML = t.workerRegion + '<span style="color: #ffaa00;">ğŸ”§ ' + t.customIPModeDesc + '</span>';

                            // æ˜¾ç¤ºè‡ªå®šä¹‰IPé…ç½®çŠ¶æ€ï¼ŒåŒ…å«å…·ä½“IP
                                if (backupStatus) backupStatus.innerHTML = t.proxyIPStatus + '<span style="color: #ffaa00;">ğŸ”§ ' + t.usingCustomProxyIP + customIPInfo + '</span>';
                                if (currentIP) currentIP.innerHTML = t.currentIP + '<span style="color: #ffaa00;">âœ… ' + customIPInfo + t.customIPConfig + '</span>';
                                if (regionMatch) regionMatch.innerHTML = t.regionMatch + '<span style="color: #ffaa00;">âš ï¸ ' + t.customIPModeDisabled + '</span>';

                            return; // æå‰è¿”å›ï¼Œä¸æ‰§è¡Œåç»­çš„åœ°åŒºåŒ¹é…é€»è¾‘
                            } else if (data.detectionMethod === 'æ‰‹åŠ¨æŒ‡å®šåœ°åŒº' || data.detectionMethod === 'ØªØ¹ÛŒÛŒÙ† Ù…Ù†Ø·Ù‚Ù‡ Ø¯Ø³ØªÛŒ') {
                            isManualRegionMode = true;
                            detectedRegion = data.region;

                                geoInfo.innerHTML = t.detectionMethod + '<span style="color: #44aa44;">' + t.manualRegion + '</span>';
                                regionStatus.innerHTML = t.workerRegion + '<span style="color: #44ff44;">ğŸ¯ ' + t.regionNames[detectedRegion] + t.manualRegionDesc + '</span>';

                            // æ˜¾ç¤ºé…ç½®çŠ¶æ€è€Œä¸æ˜¯æ£€æµ‹çŠ¶æ€
                                if (backupStatus) backupStatus.innerHTML = t.proxyIPStatus + '<span style="color: #44ff44;">âœ… ' + t.proxyIPAvailable + '</span>';
                                if (currentIP) currentIP.innerHTML = t.currentIP + '<span style="color: #44ff44;">âœ… ' + t.smartSelection + '</span>';
                                if (regionMatch) regionMatch.innerHTML = t.regionMatch + '<span style="color: #44ff44;">âœ… ' + t.sameRegionIP + '</span>';

                            return; // æå‰è¿”å›ï¼Œä¸æ‰§è¡Œåç»­çš„åœ°åŒºåŒ¹é…é€»è¾‘
                            } else if (data.region && t.regionNames[data.region]) {
                            detectedRegion = data.region;
                        }

                            geoInfo.innerHTML = t.detectionMethod + '<span style="color: #44ff44;">' + t.cloudflareDetection + '</span>';

                    } catch (e) {
                            geoInfo.innerHTML = t.detectionMethod + '<span style="color: #ff4444;">' + t.detectionFailed + '</span>';
                    }

                        regionStatus.innerHTML = t.workerRegion + '<span style="color: #44ff44;">âœ… ' + t.regionNames[detectedRegion] + '</span>';

                    // ç›´æ¥æ˜¾ç¤ºé…ç½®çŠ¶æ€ï¼Œä¸å†è¿›è¡Œæ£€æµ‹
                    if (backupStatus) {
                            backupStatus.innerHTML = t.proxyIPStatus + '<span style="color: #44ff44;">âœ… ' + t.proxyIPAvailable + '</span>';
                    }

                    if (currentIP) {
                            currentIP.innerHTML = t.currentIP + '<span style="color: #44ff44;">âœ… ' + t.smartSelection + '</span>';
                    }

                    if (regionMatch) {
                            regionMatch.innerHTML = t.regionMatch + '<span style="color: #44ff44;">âœ… ' + t.sameRegionIP + '</span>';
                    }

                } catch (error) {
                        function getCookie(name) {
                            const value = '; ' + document.cookie;
                            const parts = value.split('; ' + name + '=');
                            if (parts.length === 2) return parts.pop().split(';').shift();
                            return null;
                        }

                        const browserLang = navigator.language || navigator.userLanguage || '';
                        const savedLang = localStorage.getItem('preferredLanguage') || getCookie('preferredLanguage');
                        let isFarsi = false;

                        if (savedLang === 'fa' || savedLang === 'fa-IR') {
                            isFarsi = true;
                        } else {
                            isFarsi = browserLang.includes('fa') || browserLang.includes('fa-IR');
                        }

                        const translations = {
                            zh: {
                                workerRegion: 'Workeråœ°åŒº: ',
                                detectionMethod: 'æ£€æµ‹æ–¹å¼: ',
                                proxyIPStatus: 'ProxyIPçŠ¶æ€: ',
                                currentIP: 'å½“å‰ä½¿ç”¨IP: ',
                                regionMatch: 'åœ°åŒºåŒ¹é…: ',
                                detectionFailed: 'æ£€æµ‹å¤±è´¥'
                            },
                            fa: {
                                workerRegion: 'Ù…Ù†Ø·Ù‚Ù‡ Worker: ',
                                detectionMethod: 'Ø±ÙˆØ´ ØªØ´Ø®ÛŒØµ: ',
                                proxyIPStatus: 'ÙˆØ¶Ø¹ÛŒØª ProxyIP: ',
                                currentIP: 'IP ÙØ¹Ù„ÛŒ: ',
                                regionMatch: 'ØªØ·Ø¨ÛŒÙ‚ Ù…Ù†Ø·Ù‚Ù‡: ',
                                detectionFailed: 'ØªØ´Ø®ÛŒØµ Ù†Ø§Ù…ÙˆÙÙ‚'
                            }
                        };

                        const t = translations[isFarsi ? 'fa' : 'zh'];

                        document.getElementById('regionStatus').innerHTML = t.workerRegion + '<span style="color: #ff4444;">âŒ ' + t.detectionFailed + '</span>';
                        document.getElementById('geoInfo').innerHTML = t.detectionMethod + '<span style="color: #ff4444;">âŒ ' + t.detectionFailed + '</span>';
                        document.getElementById('backupStatus').innerHTML = t.proxyIPStatus + '<span style="color: #ff4444;">âŒ ' + t.detectionFailed + '</span>';
                        document.getElementById('currentIP').innerHTML = t.currentIP + '<span style="color: #ff4444;">âŒ ' + t.detectionFailed + '</span>';
                        document.getElementById('regionMatch').innerHTML = t.regionMatch + '<span style="color: #ff4444;">âŒ ' + t.detectionFailed + '</span>';
                }
            }

                async function testAPI() {
                    try {
                        function getCookie(name) {
                            const value = '; ' + document.cookie;
                            const parts = value.split('; ' + name + '=');
                            if (parts.length === 2) return parts.pop().split(';').shift();
                            return null;
                        }

                        const browserLang = navigator.language || navigator.userLanguage || '';
                        const savedLang = localStorage.getItem('preferredLanguage') || getCookie('preferredLanguage');
                        let isFarsi = false;

                        if (savedLang === 'fa' || savedLang === 'fa-IR') {
                            isFarsi = true;
                        } else {
                            isFarsi = browserLang.includes('fa') || browserLang.includes('fa-IR');
                        }

                        const translations = {
                            zh: {
                                apiTestResult: 'APIæ£€æµ‹ç»“æœ: ',
                                apiTestTime: 'æ£€æµ‹æ—¶é—´: ',
                                apiTestFailed: 'APIæ£€æµ‹å¤±è´¥: ',
                                unknownError: 'æœªçŸ¥é”™è¯¯',
                                apiTestError: 'APIæµ‹è¯•å¤±è´¥: '
                            },
                            fa: {
                                apiTestResult: 'Ù†ØªÛŒØ¬Ù‡ ØªØ´Ø®ÛŒØµ API: ',
                                apiTestTime: 'Ø²Ù…Ø§Ù† ØªØ´Ø®ÛŒØµ: ',
                                apiTestFailed: 'ØªØ´Ø®ÛŒØµ API Ù†Ø§Ù…ÙˆÙÙ‚: ',
                                unknownError: 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡',
                                apiTestError: 'ØªØ³Øª API Ù†Ø§Ù…ÙˆÙÙ‚: '
                            }
                        };

                        const t = translations[isFarsi ? 'fa' : 'zh'];

                    const response = await fetch(window.location.pathname + '/test-api');
                    const data = await response.json();

                    if (data.detectedRegion) {
                            alert(t.apiTestResult + data.detectedRegion + '\n' + t.apiTestTime + data.timestamp);
                    } else {
                            alert(t.apiTestFailed + (data.error || t.unknownError));
                    }
                } catch (error) {
                        function getCookie(name) {
                            const value = '; ' + document.cookie;
                            const parts = value.split('; ' + name + '=');
                            if (parts.length === 2) return parts.pop().split(';').shift();
                            return null;
                        }

                        const browserLang = navigator.language || navigator.userLanguage || '';
                        const savedLang = localStorage.getItem('preferredLanguage') || getCookie('preferredLanguage');
                        let isFarsi = false;

                        if (savedLang === 'fa' || savedLang === 'fa-IR') {
                            isFarsi = true;
                        } else {
                            isFarsi = browserLang.includes('fa') || browserLang.includes('fa-IR');
                        }

                        const translations = {
                            zh: { apiTestError: 'APIæµ‹è¯•å¤±è´¥: ' },
                            fa: { apiTestError: 'ØªØ³Øª API Ù†Ø§Ù…ÙˆÙÙ‚: ' }
                        };

                        const t = translations[isFarsi ? 'fa' : 'zh'];
                        alert(t.apiTestError + error.message);
                }
            }

            // é…ç½®ç®¡ç†ç›¸å…³å‡½æ•°
            async function checkKVStatus() {
                const apiUrl = window.location.pathname + '/api/config';

                try {
                    const response = await fetch(apiUrl);

                        function getCookie(name) {
                            const value = '; ' + document.cookie;
                            const parts = value.split('; ' + name + '=');
                            if (parts.length === 2) return parts.pop().split(';').shift();
                            return null;
                        }

                        const browserLang = navigator.language || navigator.userLanguage || '';
                        const savedLang = localStorage.getItem('preferredLanguage') || getCookie('preferredLanguage');
                        let isFarsi = false;

                        if (savedLang === 'fa' || savedLang === 'fa-IR') {
                            isFarsi = true;
                        } else {
                            isFarsi = browserLang.includes('fa') || browserLang.includes('fa-IR');
                        }

                        const translations = {
                            zh: {
                                kvDisabled: 'âš ï¸ KVå­˜å‚¨æœªå¯ç”¨æˆ–æœªé…ç½®',
                                kvNotConfigured: 'KVå­˜å‚¨æœªé…ç½®ï¼Œæ— æ³•ä½¿ç”¨é…ç½®ç®¡ç†åŠŸèƒ½ã€‚\n\nè¯·åœ¨Cloudflare Workersä¸­:\n1. åˆ›å»ºKVå‘½åç©ºé—´\n2. ç»‘å®šç¯å¢ƒå˜é‡ C\n3. é‡æ–°éƒ¨ç½²ä»£ç ',
                                kvNotEnabled: 'KVå­˜å‚¨æœªé…ç½®',
                                kvEnabled: 'âœ… KVå­˜å‚¨å·²å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨é…ç½®ç®¡ç†åŠŸèƒ½',
                                kvCheckFailed: 'âš ï¸ KVå­˜å‚¨æ£€æµ‹å¤±è´¥',
                                kvCheckFailedFormat: 'KVå­˜å‚¨æ£€æµ‹å¤±è´¥: å“åº”æ ¼å¼é”™è¯¯',
                                kvCheckFailedStatus: 'KVå­˜å‚¨æ£€æµ‹å¤±è´¥ - çŠ¶æ€ç : ',
                                kvCheckFailedError: 'KVå­˜å‚¨æ£€æµ‹å¤±è´¥ - é”™è¯¯: '
                            },
                            fa: {
                                kvDisabled: 'âš ï¸ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ KV ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª ÛŒØ§ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª',
                                kvNotConfigured: 'Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ KV Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³ØªØŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.\n\nÙ„Ø·ÙØ§ Ø¯Ø± Cloudflare Workers:\n1. ÙØ¶Ø§ÛŒ Ù†Ø§Ù… KV Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯\n2. Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ C Ø±Ø§ Ù¾ÛŒÙˆÙ†Ø¯ Ø¯Ù‡ÛŒØ¯\n3. Ú©Ø¯ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù…Ø³ØªÙ‚Ø± Ú©Ù†ÛŒØ¯',
                                kvNotEnabled: 'Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ KV Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª',
                                kvEnabled: 'âœ… Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ KV ÙØ¹Ø§Ù„ Ø§Ø³ØªØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯',
                                kvCheckFailed: 'âš ï¸ Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ KV Ù†Ø§Ù…ÙˆÙÙ‚',
                                kvCheckFailedFormat: 'Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ KV Ù†Ø§Ù…ÙˆÙÙ‚: Ø®Ø·Ø§ÛŒ ÙØ±Ù…Øª Ù¾Ø§Ø³Ø®',
                                kvCheckFailedStatus: 'Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ KV Ù†Ø§Ù…ÙˆÙÙ‚ - Ú©Ø¯ ÙˆØ¶Ø¹ÛŒØª: ',
                                kvCheckFailedError: 'Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ KV Ù†Ø§Ù…ÙˆÙÙ‚ - Ø®Ø·Ø§: '
                            }
                        };

                        const t = translations[isFarsi ? 'fa' : 'zh'];

                        if (response.status === 503) {
                            // KVæœªé…ç½®
                            document.getElementById('kvStatus').innerHTML = '<span style="color: #ffaa00;">' + t.kvDisabled + '</span>';
                            document.getElementById('configCard').style.display = 'block';
                            document.getElementById('currentConfig').textContent = t.kvNotConfigured;
                    } else if (response.ok) {
                        try {
                        const data = await response.json();

                            // æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å«KVé…ç½®ä¿¡æ¯
                            if (data && data.kvEnabled === true) {
                                document.getElementById('kvStatus').innerHTML = '<span style="color: #44ff44;">' + t.kvEnabled + '</span>';
                                document.getElementById('configContent').style.display = 'block';
                                document.getElementById('configCard').style.display = 'block';
                                await loadCurrentConfig();
                            } else {
                                document.getElementById('kvStatus').innerHTML = '<span style="color: #ffaa00;">' + t.kvDisabled + '</span>';
                                document.getElementById('configCard').style.display = 'block';
                                document.getElementById('currentConfig').textContent = t.kvNotEnabled;
                                }
                        } catch (jsonError) {
                            document.getElementById('kvStatus').innerHTML = '<span style="color: #ffaa00;">' + t.kvCheckFailed + '</span>';
                            document.getElementById('configCard').style.display = 'block';
                            document.getElementById('currentConfig').textContent = t.kvCheckFailedFormat;
                        }
                    } else {
                        document.getElementById('kvStatus').innerHTML = '<span style="color: #ffaa00;">' + t.kvDisabled + '</span>';
                        document.getElementById('configCard').style.display = 'block';
                        document.getElementById('currentConfig').textContent = t.kvCheckFailedStatus + response.status;
                    }
                } catch (error) {
                    function getCookie(name) {
                        const value = '; ' + document.cookie;
                        const parts = value.split('; ' + name + '=');
                        if (parts.length === 2) return parts.pop().split(';').shift();
                        return null;
                    }

                    const browserLang = navigator.language || navigator.userLanguage || '';
                    const savedLang = localStorage.getItem('preferredLanguage') || getCookie('preferredLanguage');
                    let isFarsi = false;

                    if (savedLang === 'fa' || savedLang === 'fa-IR') {
                        isFarsi = true;
                    } else {
                        isFarsi = browserLang.includes('fa') || browserLang.includes('fa-IR');
                    }

                    const translations = {
                        zh: {
                            kvDisabled: 'âš ï¸ KVå­˜å‚¨æœªå¯ç”¨æˆ–æœªé…ç½®',
                            kvCheckFailedError: 'KVå­˜å‚¨æ£€æµ‹å¤±è´¥ - é”™è¯¯: '
                        },
                        fa: {
                            kvDisabled: 'âš ï¸ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ KV ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª ÛŒØ§ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª',
                            kvCheckFailedError: 'Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ KV Ù†Ø§Ù…ÙˆÙÙ‚ - Ø®Ø·Ø§: '
                        }
                    };

                    const t = translations[isFarsi ? 'fa' : 'zh'];

                    document.getElementById('kvStatus').innerHTML = '<span style="color: #ffaa00;">' + t.kvDisabled + '</span>';
                    document.getElementById('configCard').style.display = 'block';
                    document.getElementById('currentConfig').textContent = t.kvCheckFailedError + error.message;
                }
            }

            async function loadCurrentConfig() {
                const apiUrl = window.location.pathname + '/api/config';

                try {
                    const response = await fetch(apiUrl);

                    if (response.status === 503) {
                        document.getElementById('currentConfig').textContent = 'KVå­˜å‚¨æœªé…ç½®ï¼Œæ— æ³•åŠ è½½é…ç½®';
                        return;
                    }
                    if (!response.ok) {
                        const errorText = await response.text();
                        document.getElementById('currentConfig').textContent = 'åŠ è½½é…ç½®å¤±è´¥: ' + errorText;
                        return;
                    }
                    const config = await response.json();

                    // è¿‡æ»¤æ‰å†…éƒ¨å­—æ®µ kvEnabled
                    const displayConfig = {};
                    for (const [key, value] of Object.entries(config)) {
                        if (key !== 'kvEnabled') {
                            displayConfig[key] = value;
                        }
                    }

                    let configText = 'å½“å‰é…ç½®:\n';
                    if (Object.keys(displayConfig).length === 0) {
                        configText += '(æš‚æ— é…ç½®)';
                    } else {
                        for (const [key, value] of Object.entries(displayConfig)) {
                            configText += key + ': ' + (value || '(æœªè®¾ç½®)') + '\n';
                        }
                    }

                    document.getElementById('currentConfig').textContent = configText;

                    // æ›´æ–°è¡¨å•å€¼
                    document.getElementById('wkRegion').value = config.wk || '';
                    document.getElementById('ev').checked = config.ev !== 'no';
                    document.getElementById('et').checked = config.et === 'yes';
                    document.getElementById('ex').checked = config.ex === 'yes';
                    document.getElementById('ech').checked = config.ech === 'yes';
                    document.getElementById('tp').value = config.tp || '';
                    if (document.getElementById('customDNS')) {
                        document.getElementById('customDNS').value = config.customDNS || '';
                    }
                    if (document.getElementById('customECHDomain')) {
                        document.getElementById('customECHDomain').value = config.customECHDomain || '';
                    }
                    document.getElementById('scu').value = config.scu || '';
                    document.getElementById('epd').checked = config.epd !== 'no';
                    document.getElementById('epi').checked = config.epi !== 'no';
                    document.getElementById('egi').checked = config.egi !== 'no';
                    if (document.getElementById('ipv4Enabled')) document.getElementById('ipv4Enabled').checked = config.ipv4 !== 'no';
                    if (document.getElementById('ipv6Enabled')) document.getElementById('ipv6Enabled').checked = config.ipv6 !== 'no';
                    if (document.getElementById('ispMobile')) document.getElementById('ispMobile').checked = config.ispMobile !== 'no';
                    if (document.getElementById('ispUnicom')) document.getElementById('ispUnicom').checked = config.ispUnicom !== 'no';
                    if (document.getElementById('ispTelecom')) document.getElementById('ispTelecom').checked = config.ispTelecom !== 'no';
                    document.getElementById('customPath').value = config.d || '';
                    document.getElementById('customIP').value = config.p || '';
                    document.getElementById('yx').value = config.yx || '';
                    document.getElementById('yxURL').value = config.yxURL || '';
                    document.getElementById('socksConfig').value = config.s || '';
                    document.getElementById('customHomepage').value = config.homepage || '';
                    document.getElementById('apiEnabled').value = config.ae || '';
                    document.getElementById('regionMatching').value = config.rm || '';
                    document.getElementById('downgradeControl').value = config.qj || '';
                    document.getElementById('portControl').value = config.dkby || '';
                    document.getElementById('preferredControl').value = config.yxby || '';

                    // æ›´æ–°è·¯å¾„ç±»å‹æ˜¾ç¤º
                    updatePathTypeStatus(config.d);

                    // æ£€æŸ¥på˜é‡ï¼Œå¦‚æœæœ‰å€¼åˆ™ç¦ç”¨wkåœ°åŒºé€‰æ‹©
                    updateWkRegionState();

                } catch (error) {
                    document.getElementById('currentConfig').textContent = 'åŠ è½½é…ç½®å¤±è´¥: ' + error.message;
                }
            }

            // æ›´æ–°è·¯å¾„ç±»å‹æ˜¾ç¤º
            function updatePathTypeStatus(cp) {
                const pathTypeStatus = document.getElementById('pathTypeStatus');
                const currentUrl = window.location.href;
                const pathParts = window.location.pathname.split('/').filter(p => p);
                const currentPath = pathParts.length > 0 ? pathParts[0] : '';

                if (cp && cp.trim()) {
                    // ä½¿ç”¨è‡ªå®šä¹‰è·¯å¾„ (d)
                    pathTypeStatus.innerHTML = '<div style="color: #44ff44;">ä½¿ç”¨ç±»å‹: <strong>è‡ªå®šä¹‰è·¯å¾„ (d)</strong></div>' +
                        '<div style="margin-top: 5px; color: #00ff00;">å½“å‰è·¯å¾„: <span style="color: #ffaa00;">' + cp + '</span></div>' +
                        '<div style="margin-top: 5px; font-size: 0.9rem; color: #00aa00;">è®¿é—®åœ°å€: ' + 
                        (currentUrl.split('/')[0] + '//' + currentUrl.split('/')[2]) + cp + '/sub</div>';
                } else {
                    // ä½¿ç”¨ UUID (u)
                    pathTypeStatus.innerHTML = '<div style="color: #44ff44;">ä½¿ç”¨ç±»å‹: <strong>UUID è·¯å¾„ (u)</strong></div>' +
                        '<div style="margin-top: 5px; color: #00ff00;">å½“å‰è·¯å¾„: <span style="color: #ffaa00;">' + (currentPath || '(UUID)') + '</span></div>' +
                        '<div style="margin-top: 5px; font-size: 0.9rem; color: #00aa00;">è®¿é—®åœ°å€: ' + currentUrl.split('/sub')[0] + '/sub</div>';
                }
            }

            // æ›´æ–°wkåœ°åŒºé€‰æ‹©çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€
            function updateWkRegionState() {
                const customIPInput = document.getElementById('customIP');
                const wkRegion = document.getElementById('wkRegion');
                const wkRegionHint = document.getElementById('wkRegionHint');

                if (customIPInput && wkRegion) {
                    const hasCustomIP = customIPInput.value.trim() !== '';
                    wkRegion.disabled = hasCustomIP;

                    // æ·»åŠ è§†è§‰åé¦ˆ
                    if (hasCustomIP) {
                        wkRegion.style.opacity = '0.5';
                        wkRegion.style.cursor = 'not-allowed';
                        wkRegion.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                        if (wkRegionHint) {
                            wkRegionHint.style.display = 'block';
                            wkRegionHint.style.color = '#ffaa00';
                        }
                    } else {
                        wkRegion.style.opacity = '1';
                        wkRegion.style.cursor = 'pointer';
                        wkRegion.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                        // éšè—æç¤ºä¿¡æ¯
                        if (wkRegionHint) {
                            wkRegionHint.style.display = 'none';
                        }
                    }
                }
            }

            async function saveConfig(configData) {
                const apiUrl = window.location.pathname + '/api/config';

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(configData)
                    });


                    if (response.status === 503) {
                        showStatus('KVå­˜å‚¨æœªé…ç½®ï¼Œæ— æ³•ä¿å­˜é…ç½®ã€‚è¯·å…ˆåœ¨Cloudflare Workersä¸­é…ç½®KVå­˜å‚¨ã€‚', 'error');
                        return;
                    }

                    if (!response.ok) {
                        const errorText = await response.text();

                        // å°è¯•è§£æ JSON é”™è¯¯ä¿¡æ¯
                        try {
                            const errorData = JSON.parse(errorText);
                            showStatus(errorData.message || 'ä¿å­˜å¤±è´¥', 'error');
                        } catch (parseError) {
                            // å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
                            showStatus('ä¿å­˜å¤±è´¥: ' + errorText, 'error');
                        }
                        return;
                    }

                    const result = await response.json();

                    showStatus(result.message, result.success ? 'success' : 'error');

                    if (result.success) {
                        await loadCurrentConfig();
                        // æ›´æ–°wkåœ°åŒºé€‰æ‹©çŠ¶æ€
                        updateWkRegionState();
                        // ä¿å­˜æˆåŠŸååˆ·æ–°é¡µé¢ä»¥æ›´æ–°ç³»ç»ŸçŠ¶æ€
                        setTimeout(function() {
                            window.location.reload();
                        }, 1500);
                    } else {
                    }
                } catch (error) {
                    showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                }
            }

            function showStatus(message, type) {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.textContent = message;
                statusDiv.style.display = 'block';
                statusDiv.style.color = type === 'success' ? '#00ff00' : '#ff0000';
                statusDiv.style.borderColor = type === 'success' ? '#00ff00' : '#ff0000';

                setTimeout(function() {
                    statusDiv.style.display = 'none';
                }, 3000);
            }

            async function resetAllConfig() {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿè¿™å°†æ¸…ç©ºæ‰€æœ‰KVé…ç½®ï¼Œæ¢å¤ä¸ºç¯å¢ƒå˜é‡è®¾ç½®ã€‚')) {
                    try {
                        const response = await fetch(window.location.pathname + '/api/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                wk: '',
                                d: '',
                                p: '',
                                yx: '',
                                yxURL: '',
                                s: '', ae: '',
                                rm: '',
                                qj: '',
                                dkby: '',
                                yxby: '', ev: '', et: '', ex: '', tp: '', scu: '', epd: '', epi: '', egi: '',
                                ipv4: '', ipv6: '', ispMobile: '', ispUnicom: '', ispTelecom: '',
                                homepage: ''
                            })
                        });

                        if (response.status === 503) {
                            showStatus('KVå­˜å‚¨æœªé…ç½®ï¼Œæ— æ³•é‡ç½®é…ç½®ã€‚', 'error');
                            return;
                        }

                        if (!response.ok) {
                            const errorText = await response.text();

                            // å°è¯•è§£æ JSON é”™è¯¯ä¿¡æ¯
                            try {
                                const errorData = JSON.parse(errorText);
                                showStatus(errorData.message || 'é‡ç½®å¤±è´¥', 'error');
                            } catch (parseError) {
                                // å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
                                showStatus('é‡ç½®å¤±è´¥: ' + errorText, 'error');
                            }
                            return;
                        }

                        const result = await response.json();
                        showStatus(result.message || 'é…ç½®å·²é‡ç½®', result.success ? 'success' : 'error');

                        if (result.success) {
                            await loadCurrentConfig();
                            // æ›´æ–°wkåœ°åŒºé€‰æ‹©çŠ¶æ€
                            updateWkRegionState();
                            // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°ç³»ç»ŸçŠ¶æ€
                            setTimeout(function() {
                                window.location.reload();
                            }, 1500);
                        }
                    } catch (error) {
                        showStatus('é‡ç½®å¤±è´¥: ' + error.message, 'error');
                    }
                }
            }

            async function checkECHStatus() {
                const echStatusEl = document.getElementById('echStatus');

                if (!echStatusEl) return;

                try {
                    const currentUrl = window.location.href;
                    const subscriptionUrl = currentUrl + '/sub';

                    echStatusEl.innerHTML = 'ECHçŠ¶æ€: <span style="color: #ffaa00;">æ£€æµ‹ä¸­...</span>';

                    const response = await fetch(subscriptionUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/plain'
                        }
                    });

                    const echStatusHeader = response.headers.get('X-ECH-Status');
                    const echConfigLength = response.headers.get('X-ECH-Config-Length');

                    if (echStatusHeader === 'ENABLED') {
                        echStatusEl.innerHTML = 'ECHçŠ¶æ€: <span style="color: #44ff44;">âœ… å·²å¯ç”¨' + (echConfigLength ? ' (é…ç½®é•¿åº¦: ' + echConfigLength + ')' : '') + '</span>';
                    } else {
                        echStatusEl.innerHTML = 'ECHçŠ¶æ€: <span style="color: #ffaa00;">âš ï¸ æœªå¯ç”¨</span>';
                    }
                } catch (error) {
                    echStatusEl.innerHTML = 'ECHçŠ¶æ€: <span style="color: #ff4444;">âŒ æ£€æµ‹å¤±è´¥: ' + error.message + '</span>';
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                createMatrixRain();
                checkSystemStatus();
                checkKVStatus();
                checkECHStatus();

                // ECH å¼€å¯æ—¶è‡ªåŠ¨è”åŠ¨å¼€å¯ä»…TLS
                const echCheckbox = document.getElementById('ech');
                const portControl = document.getElementById('portControl');
                if (echCheckbox && portControl) {
                    echCheckbox.addEventListener('change', function() {
                        if (this.checked) {
                            // ECH å¼€å¯æ—¶ï¼Œè‡ªåŠ¨è®¾ç½®ä»…TLSä¸º yes
                            portControl.value = 'yes';
                        }
                    });

                    // é¡µé¢åŠ è½½æ—¶ï¼Œå¦‚æœ ECH å·²å‹¾é€‰ï¼Œä¹Ÿè‡ªåŠ¨è®¾ç½®ä»…TLS
                    if (echCheckbox.checked) {
                        portControl.value = 'yes';
                    }
                }

                // ç›‘å¬customIPè¾“å…¥æ¡†å˜åŒ–ï¼Œå®æ—¶æ›´æ–°wkåœ°åŒºé€‰æ‹©çŠ¶æ€
                const customIPInput = document.getElementById('customIP');
                if (customIPInput) {
                    customIPInput.addEventListener('input', function() {
                        updateWkRegionState();
                    });
                }

                // ç»‘å®šè¡¨å•äº‹ä»¶
                const regionForm = document.getElementById('regionForm');
                if (regionForm) {
                    regionForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        const wkRegion = document.getElementById('wkRegion').value;
                        await saveConfig({ wk: wkRegion });
                    });
                }

                const saveProtocolBtn = document.getElementById('saveProtocolBtn');
                if (saveProtocolBtn) {
                    saveProtocolBtn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        const configData = { 
                            ev: document.getElementById('ev').checked ? 'yes' : 'no', 
                            et: document.getElementById('et').checked ? 'yes' : 'no', 
                            ex: document.getElementById('ex').checked ? 'yes' : 'no', 
                            ech: document.getElementById('ech').checked ? 'yes' : 'no',
                            tp: document.getElementById('tp').value,
                            customDNS: document.getElementById('customDNS').value,
                            customECHDomain: document.getElementById('customECHDomain').value
                        };

                        if (!document.getElementById('ev').checked && 
                            !document.getElementById('et').checked && 
                            !document.getElementById('ex').checked) {
                            alert('è‡³å°‘éœ€è¦å¯ç”¨ä¸€ä¸ªåè®®ï¼');
                            return;
                        }

                        await saveConfig(configData);
                    });
                }

                const otherConfigForm = document.getElementById('otherConfigForm');
                if (otherConfigForm) {
                    otherConfigForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        const configData = { ev: document.getElementById('ev').checked ? 'yes' : 'no', et: document.getElementById('et').checked ? 'yes' : 'no', ex: document.getElementById('ex').checked ? 'yes' : 'no', ech: document.getElementById('ech').checked ? 'yes' : 'no', tp: document.getElementById('tp').value,
                            d: document.getElementById('customPath').value,
                            p: document.getElementById('customIP').value,
                            yx: document.getElementById('yx').value,
                            yxURL: document.getElementById('yxURL').value,
                            s: document.getElementById('socksConfig').value,
                            homepage: document.getElementById('customHomepage').value,
                            customDNS: document.getElementById('customDNS').value,
                            customECHDomain: document.getElementById('customECHDomain').value
                        };

                        // ç¡®ä¿è‡³å°‘é€‰æ‹©ä¸€ä¸ªåè®®
                        if (!document.getElementById('ev').checked && 
                            !document.getElementById('et').checked && 
                            !document.getElementById('ex').checked) {
                            alert('è‡³å°‘éœ€è¦å¯ç”¨ä¸€ä¸ªåè®®ï¼');
                            return;
                        }

                        await saveConfig(configData);
                    });
                }

                const advancedConfigForm = document.getElementById('advancedConfigForm');
                if (advancedConfigForm) {
                    advancedConfigForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        const configData = { scu: document.getElementById('scu').value, epd: document.getElementById('epd').checked ? 'yes' : 'no', epi: document.getElementById('epi').checked ? 'yes' : 'no', egi: document.getElementById('egi').checked ? 'yes' : 'no', ae: document.getElementById('apiEnabled').value,
                            rm: document.getElementById('regionMatching').value,
                            qj: document.getElementById('downgradeControl').value,
                            dkby: document.getElementById('portControl').value,
                            yxby: document.getElementById('preferredControl').value,
                            ipv4: document.getElementById('ipv4Enabled').checked ? 'yes' : 'no',
                            ipv6: document.getElementById('ipv6Enabled').checked ? 'yes' : 'no',
                            ispMobile: document.getElementById('ispMobile').checked ? 'yes' : 'no',
                            ispUnicom: document.getElementById('ispUnicom').checked ? 'yes' : 'no',
                            ispTelecom: document.getElementById('ispTelecom').checked ? 'yes' : 'no'
                        };
                        await saveConfig(configData);
                    });
                }

                let testAbortController = null;
                let testResults = [];

                const startTestBtn = document.getElementById('startLatencyTest');
                const stopTestBtn = document.getElementById('stopLatencyTest');
                const testStatus = document.getElementById('latencyTestStatus');
                const testResultsDiv = document.getElementById('latencyTestResults');
                const resultsList = document.getElementById('latencyResultsList');
                const overwriteSelectedBtn = document.getElementById('overwriteSelectedToYx');
                const appendSelectedBtn = document.getElementById('appendSelectedToYx');
                const selectAllBtn = document.getElementById('selectAllResults');
                const deselectAllBtn = document.getElementById('deselectAllResults');
                const ipSourceSelect = document.getElementById('ipSourceSelect');
                const manualInputDiv = document.getElementById('manualInputDiv');
                const urlFetchDiv = document.getElementById('urlFetchDiv');
                const latencyTestInput = document.getElementById('latencyTestInput');
                const fetchURLInput = document.getElementById('fetchURLInput');
                const latencyTestPort = document.getElementById('latencyTestPort');
                const randomIPCount = document.getElementById('randomIPCount');
                const cfRandomDiv = document.getElementById('cfRandomDiv');
                const randomCountDiv = document.getElementById('randomCountDiv');
                const generateCFIPBtn = document.getElementById('generateCFIPBtn');
                const fetchIPBtn = document.getElementById('fetchIPBtn');

                if (latencyTestInput) {
                    const savedTestInput = localStorage.getItem('latencyTestInput');
                    if (savedTestInput) latencyTestInput.value = savedTestInput;
                    latencyTestInput.addEventListener('input', function() {
                        localStorage.setItem('latencyTestInput', this.value);
                    });
                }
                if (fetchURLInput) {
                    const savedFetchURL = localStorage.getItem('fetchURLInput');
                    if (savedFetchURL) fetchURLInput.value = savedFetchURL;
                    fetchURLInput.addEventListener('input', function() {
                        localStorage.setItem('fetchURLInput', this.value);
                    });
                }
                if (latencyTestPort) {
                    const savedPort = localStorage.getItem('latencyTestPort');
                    if (savedPort) latencyTestPort.value = savedPort;
                    latencyTestPort.addEventListener('input', function() {
                        localStorage.setItem('latencyTestPort', this.value);
                    });
                }
                if (randomIPCount) {
                    const savedCount = localStorage.getItem('randomIPCount');
                    if (savedCount) randomIPCount.value = savedCount;
                    randomIPCount.addEventListener('input', function() {
                        localStorage.setItem('randomIPCount', this.value);
                    });
                    // åˆå§‹åŒ–æ—¶ï¼Œå¦‚æœé»˜è®¤æ˜¯éšè—çš„ï¼Œåˆ™ç¦ç”¨è¾“å…¥æ¡†
                    if (randomCountDiv && randomCountDiv.style.display === 'none') {
                        randomIPCount.disabled = true;
                    }
                }
                const testThreadsInput = document.getElementById('testThreads');
                if (testThreadsInput) {
                    const savedThreads = localStorage.getItem('testThreads');
                    if (savedThreads) testThreadsInput.value = savedThreads;
                    testThreadsInput.addEventListener('input', function() {
                        localStorage.setItem('testThreads', this.value);
                    });
                }
                if (ipSourceSelect) {
                    const savedSource = localStorage.getItem('ipSourceSelect');
                    const currentSource = savedSource || ipSourceSelect.value || 'manual';
                    if (savedSource) {
                        ipSourceSelect.value = savedSource;
                    }
                    manualInputDiv.style.display = currentSource === 'manual' ? 'block' : 'none';
                    urlFetchDiv.style.display = currentSource === 'urlFetch' ? 'block' : 'none';
                    cfRandomDiv.style.display = currentSource === 'cfRandom' ? 'block' : 'none';
                    randomCountDiv.style.display = currentSource === 'cfRandom' ? 'block' : 'none';
                    // å½“éšè—æ—¶ç¦ç”¨è¾“å…¥æ¡†ï¼Œé¿å…è¡¨å•éªŒè¯é”™è¯¯
                    if (randomIPCount) {
                        randomIPCount.disabled = currentSource !== 'cfRandom';
                    }
                }

                const CF_CIDR_LIST = [
                    '173.245.48.0/20', '103.21.244.0/22', '103.22.200.0/22', '103.31.4.0/22',
                    '141.101.64.0/18', '108.162.192.0/18', '190.93.240.0/20', '188.114.96.0/20',
                    '197.234.240.0/22', '198.41.128.0/17', '162.158.0.0/15', '104.16.0.0/13',
                    '104.24.0.0/14', '172.64.0.0/13', '131.0.72.0/22'
                ];

                function generateRandomIPFromCIDR(cidr) {
                    const [baseIP, prefixLength] = cidr.split('/');
                    const prefix = parseInt(prefixLength);
                    const hostBits = 32 - prefix;
                    const ipParts = baseIP.split('.').map(p => parseInt(p));
                    const ipInt = (ipParts[0] << 24) | (ipParts[1] << 16) | (ipParts[2] << 8) | ipParts[3];
                    const randomOffset = Math.floor(Math.random() * Math.pow(2, hostBits));
                    const mask = (0xFFFFFFFF << hostBits) >>> 0;
                    const randomIP = (((ipInt & mask) >>> 0) + randomOffset) >>> 0;
                    return [(randomIP >>> 24) & 0xFF, (randomIP >>> 16) & 0xFF, (randomIP >>> 8) & 0xFF, randomIP & 0xFF].join('.');
                }

                function generateCFRandomIPs(count, port) {
                    const ips = [];
                    for (let i = 0; i < count; i++) {
                        const cidr = CF_CIDR_LIST[Math.floor(Math.random() * CF_CIDR_LIST.length)];
                        const ip = generateRandomIPFromCIDR(cidr);
                        ips.push(ip + ':' + port);
                    }
                    return ips;
                }

                if (ipSourceSelect) {
                    ipSourceSelect.addEventListener('change', function() {
                        const value = this.value;
                        localStorage.setItem('ipSourceSelect', value);
                        manualInputDiv.style.display = value === 'manual' ? 'block' : 'none';
                        urlFetchDiv.style.display = value === 'urlFetch' ? 'block' : 'none';
                        cfRandomDiv.style.display = value === 'cfRandom' ? 'block' : 'none';
                        randomCountDiv.style.display = value === 'cfRandom' ? 'block' : 'none';
                        // å½“éšè—æ—¶ç¦ç”¨è¾“å…¥æ¡†ï¼Œé¿å…è¡¨å•éªŒè¯é”™è¯¯
                        if (randomIPCount) {
                            randomIPCount.disabled = value !== 'cfRandom';
                        }
                    });
                }

                if (generateCFIPBtn) {
                    generateCFIPBtn.addEventListener('click', function() {
                        const count = parseInt(document.getElementById('randomIPCount').value) || 20;
                        const port = document.getElementById('latencyTestPort').value || '443';
                        const ips = generateCFRandomIPs(count, port);
                        document.getElementById('latencyTestInput').value = ips.join(',');
                        manualInputDiv.style.display = 'block';
                        showStatus('å·²ç”Ÿæˆ ' + count + ' ä¸ªCFéšæœºIP', 'success');
                    });
                }

                if (fetchIPBtn) {
                    fetchIPBtn.addEventListener('click', async function() {
                        const urlInput = document.getElementById('fetchURLInput');
                        const fetchUrl = urlInput.value.trim();
                        if (!fetchUrl) {
                            alert('è¯·è¾“å…¥URL');
                            return;
                        }

                        fetchIPBtn.disabled = true;
                        fetchIPBtn.textContent = 'è·å–ä¸­...';

                        try {
                            // æ”¯æŒå¤šä¸ª URLï¼ˆé€—å·åˆ†éš”ï¼‰ä»¥åŠè¿”å›å†…å®¹ä¸­é€—å·åˆ†éš”çš„å¤šä¸ª IP/èŠ‚ç‚¹
                            const urlList = Array.from(new Set(
                                fetchUrl.split(',').map(u => u.trim()).filter(u => u)
                            ));

                            const allItems = [];

                            for (const u of urlList) {
                                const response = await fetch(u);
                                if (!response.ok) {
                                    throw new Error('HTTP ' + response.status + ' @ ' + u);
                                }
                                const text = await response.text();

                                // å…ˆæŒ‰è¡Œåˆ†å‰²ï¼Œå†åœ¨æ¯è¡Œå†…æŒ‰é€—å·åˆ†å‰²ï¼Œå…¼å®¹â€œå¤šè¡Œ + é€—å·åˆ†éš”â€ä¸¤ç§æ ¼å¼
                                const perUrlItems = text
                                    .split(/\r?\n/)
                                    .map(l => l.trim())
                                    .filter(l => l && !l.startsWith('#'))
                                    .flatMap(l => l.split(',').map(p => p.trim()).filter(p => p));

                                allItems.push(...perUrlItems);
                            }

                            if (allItems.length > 0) {
                                document.getElementById('latencyTestInput').value = allItems.join(',');
                                manualInputDiv.style.display = 'block';
                                showStatus('å·²è·å– ' + allItems.length + ' ä¸ªIP', 'success');
                            } else {
                                showStatus('æœªè·å–åˆ°æ•°æ®', 'error');
                            }
                        } catch (err) {
                            showStatus('è·å–å¤±è´¥: ' + err.message, 'error');
                        } finally {
                            fetchIPBtn.disabled = false;
                            fetchIPBtn.textContent = 'â¬‡ è·å–IP';
                        }
                    });
                }

                if (startTestBtn) {
                    startTestBtn.addEventListener('click', async function() {
                        const inputField = document.getElementById('latencyTestInput');
                        const portField = document.getElementById('latencyTestPort');
                        const threadsField = document.getElementById('testThreads');
                        const inputValue = inputField.value.trim();
                        const defaultPort = portField.value || '443';
                        const threads = parseInt(threadsField.value) || 5;

                        if (!inputValue) {
                            showStatus('è¯·è¾“å…¥IPæˆ–åŸŸå', 'error');
                            return;
                        }

                        const targets = inputValue.split(',').map(t => t.trim()).filter(t => t);
                        if (targets.length === 0) return;

                        startTestBtn.style.display = 'none';
                        stopTestBtn.style.display = 'inline-block';
                        testStatus.style.display = 'block';
                        testResultsDiv.style.display = 'block';
                        resultsList.innerHTML = '';
                        testResults = [];
                        if (cityFilterContainer) {
                            cityFilterContainer.style.display = 'none';
                        }

                        testAbortController = new AbortController();

                        let completed = 0;
                        const total = targets.length;

                        function parseTarget(target) {
                            let host = target;
                            let port = defaultPort;
                            let nodeName = '';

                            if (target.includes('#')) {
                                const parts = target.split('#');
                                nodeName = parts[1] || '';
                                host = parts[0];
                            }

                            if (host.includes(':') && !host.startsWith('[')) {
                                const lastColon = host.lastIndexOf(':');
                                const possiblePort = host.substring(lastColon + 1);
                                if (/^[0-9]+$/.test(possiblePort)) {
                                    port = possiblePort;
                                    host = host.substring(0, lastColon);
                                }
                            } else if (host.includes(']:')) {
                                const parts = host.split(']:');
                                host = parts[0] + ']';
                                port = parts[1];
                            }
                            return { host, port, nodeName };
                        }

                        function renderResult(result, index, shouldShow = true) {
                            // åªå±•ç¤ºåœ¨çº¿ä¼˜é€‰æˆåŠŸçš„ç»“æœï¼Œå¤±è´¥/è¶…æ—¶çš„ä¸å†æ˜¾ç¤º
                            if (!result.success) {
                                return null;
                            }

                            const resultItem = document.createElement('div');
                            resultItem.style.cssText = 'display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #003300; gap: 10px;';
                            resultItem.dataset.index = index;
                            resultItem.dataset.colo = result.colo || '';
                            if (!shouldShow) {
                                resultItem.style.display = 'none';
                            }

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.checked = true;
                            checkbox.disabled = false;
                            checkbox.dataset.index = index;
                            checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';

                            const info = document.createElement('div');
                            info.style.cssText = 'flex: 1; font-family: monospace; font-size: 13px;';

                            const coloName = result.colo ? getColoName(result.colo) : '';
                            const coloDisplay = coloName ? ' <span style="color: #00aaff;">[' + coloName + ']</span>' : '';
                            info.innerHTML = '<span style="color: #00ff00;">' + result.host + ':' + result.port + '</span>' + coloDisplay + ' <span style="color: #ffff00;">' + result.latency + 'ms</span>';

                            resultItem.appendChild(checkbox);
                            resultItem.appendChild(info);
                            resultsList.appendChild(resultItem);
                            return resultItem;
                        }

                        async function testOne(target) {
                            if (testAbortController.signal.aborted) return null;
                            const { host, port, nodeName } = parseTarget(target);
                            const result = await testLatency(host, port, testAbortController.signal);
                            result.host = host;
                            result.port = port;
                            result.nodeName = (result.success && result.colo) ? (nodeName || ('CF-' + result.colo)) : (nodeName || host);
                            return result;
                        }

                        for (let i = 0; i < total; i += threads) {
                            if (testAbortController.signal.aborted) break;

                            const batch = targets.slice(i, Math.min(i + threads, total));
                            testStatus.textContent = 'æµ‹è¯•ä¸­: ' + (i + 1) + '-' + Math.min(i + threads, total) + '/' + total + ' (çº¿ç¨‹: ' + threads + ')';

                            const results = await Promise.all(batch.map(t => testOne(t)));

                            for (const result of results) {
                                if (result) {
                                    const idx = testResults.length;
                                    testResults.push(result);
                                    renderResult(result, idx);
                                    completed++;
                                }
                            }
                        }

                        testStatus.textContent = 'æµ‹è¯•å®Œæˆ: ' + completed + '/' + total;
                        startTestBtn.style.display = 'inline-block';
                        stopTestBtn.style.display = 'none';

                        // æ›´æ–°åŸå¸‚é€‰æ‹©å™¨
                        updateCityFilter();
                    });
                }

                if (stopTestBtn) {
                    stopTestBtn.addEventListener('click', function() {
                        if (testAbortController) {
                            testAbortController.abort();
                        }
                        startTestBtn.style.display = 'inline-block';
                        stopTestBtn.style.display = 'none';
                        testStatus.textContent = 'æµ‹è¯•å·²åœæ­¢';
                    });
                }

                if (selectAllBtn) {
                    selectAllBtn.addEventListener('click', function() {
                        const checkboxes = resultsList.querySelectorAll('input[type="checkbox"]:not(:disabled)');
                        checkboxes.forEach(cb => cb.checked = true);
                    });
                }

                if (deselectAllBtn) {
                    deselectAllBtn.addEventListener('click', function() {
                        const checkboxes = resultsList.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => cb.checked = false);
                    });
                }
// è·å–é€‰ä¸­é¡¹çš„é€šç”¨å‡½æ•°ï¼ˆè¿”å›å¸¦å»¶è¿Ÿçš„å¯¹è±¡æ•°ç»„ï¼‰
function getSelectedItemsWithDelay() {
    const checkboxes = resultsList.querySelectorAll('input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        showStatus('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹', 'error');
        return null;
    }
    
    const selectedItems = [];
    checkboxes.forEach(cb => {
        const idx = parseInt(cb.dataset.index);
        const result = testResults[idx];
        if (result && result.success) {
            const coloName = result.colo ? getColoName(result.colo) : result.nodeName;
            
            // ä»é¡µé¢ä¸Šæ˜¾ç¤ºçš„æ–‡æœ¬ä¸­æå–å»¶è¿Ÿ
            let delay = 9999; // é»˜è®¤å€¼
            
            // å°è¯•ä»ç»“æœé¡¹çš„æ–‡æœ¬ä¸­æå–å»¶è¿Ÿ
            const resultItem = cb.closest('.result-item, [class*="result"], li, div');
            if (resultItem) {
                const text = resultItem.textContent || resultItem.innerText;
                const delayMatch = text.match(/(\d+)\s*ms/);
                if (delayMatch) {
                    delay = parseInt(delayMatch[1]);
                }
            }
            
            // å¦‚æœé¡µé¢ä¸Šæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•ä»resultå¯¹è±¡ä¸­è·å–
            if (delay === 9999 && result.delay) {
                delay = result.delay;
            }
            
            selectedItems.push({
                host: result.host,
                port: result.port,
                coloName: coloName,
                delay: delay
            });
        }
    });
    
    return selectedItems;
}

// è·å–é€‰ä¸­é¡¹çš„é€šç”¨å‡½æ•°ï¼ˆä¿æŒåŸæ ¼å¼ï¼Œç”¨äºè¦†ç›–å’Œè¿½åŠ æ·»åŠ ï¼‰
function getSelectedItems() {
    const items = getSelectedItemsWithDelay();
    if (!items) return null;
    
    // è½¬æ¢ä¸ºåŸå§‹æ ¼å¼ï¼šhost:port#coloName
    return items.map(item => `${item.host}:${item.port}#${item.coloName}`);
}

// ä¸‹è½½txtæ–‡ä»¶çš„å‡½æ•°
function downloadTextFile(filename, content) {
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// è¦†ç›–æ·»åŠ æŒ‰é’®åŠŸèƒ½
if (overwriteSelectedBtn) {
    overwriteSelectedBtn.addEventListener('click', async function() {
        const selectedItems = getSelectedItems();
        if (!selectedItems || selectedItems.length === 0) return;
        
        const yxInput = document.getElementById('yx');
        const newValue = selectedItems.join(',');
        yxInput.value = newValue;
        
        overwriteSelectedBtn.disabled = true;
        appendSelectedBtn.disabled = true;
        downloadOverwriteBtn.disabled = true;
        overwriteSelectedBtn.textContent = 'ä¿å­˜ä¸­...';
        
        try {
            const configData = {
                customIP: document.getElementById('customIP').value,
                yx: newValue,
                yxURL: document.getElementById('yxURL').value,
                socksConfig: document.getElementById('socksConfig').value
            };
            await saveConfig(configData);
            showStatus('å·²è¦†ç›– ' + selectedItems.length + ' é¡¹å¹¶å·²ä¿å­˜', 'success');
        } catch (err) {
            showStatus('ä¿å­˜å¤±è´¥: ' + err.message, 'error');
        } finally {
            overwriteSelectedBtn.disabled = false;
            appendSelectedBtn.disabled = false;
            downloadOverwriteBtn.disabled = false;
            overwriteSelectedBtn.textContent = 'è¦†ç›–æ·»åŠ ';
        }
    });
}

// è¿½åŠ æ·»åŠ æŒ‰é’®åŠŸèƒ½
if (appendSelectedBtn) {
    appendSelectedBtn.addEventListener('click', async function() {
        const selectedItems = getSelectedItems();
        if (!selectedItems || selectedItems.length === 0) return;
        
        const yxInput = document.getElementById('yx');
        const currentValue = yxInput.value.trim();
        const newItems = selectedItems.join(',');
        const newValue = currentValue ? (currentValue + ',' + newItems) : newItems;
        yxInput.value = newValue;
        
        overwriteSelectedBtn.disabled = true;
        appendSelectedBtn.disabled = true;
        downloadOverwriteBtn.disabled = true;
        appendSelectedBtn.textContent = 'ä¿å­˜ä¸­...';
        
        try {
            const configData = {
                customIP: document.getElementById('customIP').value,
                yx: newValue,
                yxURL: document.getElementById('yxURL').value,
                socksConfig: document.getElementById('socksConfig').value
            };
            await saveConfig(configData);
            showStatus('å·²è¿½åŠ  ' + selectedItems.length + ' é¡¹å¹¶å·²ä¿å­˜', 'success');
        } catch (err) {
            showStatus('ä¿å­˜å¤±è´¥: ' + err.message, 'error');
        } finally {
            overwriteSelectedBtn.disabled = false;
            appendSelectedBtn.disabled = false;
            downloadOverwriteBtn.disabled = false;
            appendSelectedBtn.textContent = 'è¿½åŠ æ·»åŠ ';
        }
    });
}

// ä¸‹è½½è¦†ç›–æ•°æ®æŒ‰é’®åŠŸèƒ½
if (downloadOverwriteBtn) {
    downloadOverwriteBtn.addEventListener('click', function() {
        const selectedItemsData = getSelectedItemsWithDelay();
        if (!selectedItemsData || selectedItemsData.length === 0) return;
        
        // æŒ‰å»¶è¿Ÿé€’å¢æ’åº
        selectedItemsData.sort((a, b) => a.delay - b.delay);
        
        // åˆ›å»ºä¸‹è½½çš„txtæ–‡ä»¶å†…å®¹ - åªåŒ…å«æ•°æ®ï¼Œæ²¡æœ‰æ³¨é‡Š
        let txtContent = '';
        
        // æ·»åŠ æ¯ä¸ªé¡¹ç›®çš„è¯¦ç»†ä¿¡æ¯ï¼ŒæŒ‰ç…§æ–°æ ¼å¼ï¼šIP:ç«¯å£#åœ°åŒº å»¶è¿Ÿms
        selectedItemsData.forEach(item => {
            txtContent += `${item.host}:${item.port}#${item.coloName} ${item.delay}ms\n`;
        });
        
        // ä¸‹è½½æ–‡ä»¶
        const timestamp = new Date().toISOString().split('T')[0];
        const filename = `ä¼˜é€‰IP_${timestamp}_${selectedItemsData.length}é¡¹.txt`;
        downloadTextFile(filename, txtContent);
        
        showStatus(`å·²ä¸‹è½½ ${selectedItemsData.length} é¡¹æ•°æ®ï¼Œå·²æŒ‰å»¶è¿Ÿæ’åº`, 'success');
    });
}

// æ–°å¢ï¼šä»é¡µé¢ç»“æœé¡¹ä¸­æå–å»¶è¿Ÿçš„è¾…åŠ©å‡½æ•°
function extractDelayFromPage(resultItem) {
    if (!resultItem) return 9999;
    
    const text = resultItem.textContent || resultItem.innerText;
    
    // å°è¯•åŒ¹é…å»¶è¿Ÿï¼ˆä¾‹å¦‚ï¼š421ms, 213msç­‰ï¼‰
    const delayMatch = text.match(/(\d+)\s*ms/);
    if (delayMatch) {
        return parseInt(delayMatch[1]);
    }
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°mså•ä½ï¼Œå°è¯•åŒ¹é…æ•°å­—
    const numberMatch = text.match(/\b(\d{3,4})\b/);
    if (numberMatch) {
        return parseInt(numberMatch[1]);
    }
    
    return 9999;
}

// å¦‚æœæ‚¨éœ€è¦å¯¼å‡ºæ‰€æœ‰æµ‹è¯•æˆåŠŸçš„æ•°æ®ï¼Œå¯ä»¥æ·»åŠ è¿™ä¸ªå‡½æ•°
if (typeof exportAllBtn !== 'undefined' && exportAllBtn) {
    exportAllBtn.addEventListener('click', function() {
        // è·å–æ‰€æœ‰æµ‹è¯•æˆåŠŸçš„æ•°æ®
        const allSuccessItems = [];
        
        // å‡è®¾ç»“æœé¡¹åœ¨é¡µé¢ä¸Šæœ‰ç‰¹å®šçš„é€‰æ‹©å™¨
        const allResultItems = document.querySelectorAll('.result-item, [class*="result"], #resultsList > div, #resultsList > li');
        
        allResultItems.forEach((item, idx) => {
            // æ£€æŸ¥è¿™ä¸ªç»“æœé¡¹æ˜¯å¦æˆåŠŸï¼ˆå¯èƒ½æœ‰æˆåŠŸæ ‡è®°ï¼‰
            const successMarker = item.querySelector('.success, .pass, [style*="green"], .status-success');
            const delayText = item.textContent || item.innerText;
            const delayMatch = delayText.match(/(\d+)\s*ms/);
            
            if (successMarker || delayMatch) {
                // å°è¯•ä»æ–‡æœ¬ä¸­æå–IPã€ç«¯å£å’Œåœ°åŒº
                const ipPortMatch = delayText.match(/(\d+\.\d+\.\d+\.\d+):(\d+)/);
                const regionMatch = delayText.match(/\[(.*?)\]/);
                
                if (ipPortMatch) {
                    const host = ipPortMatch[1];
                    const port = ipPortMatch[2];
                    const coloName = regionMatch ? regionMatch[1] : 'æœªçŸ¥åœ°åŒº';
                    const delay = delayMatch ? parseInt(delayMatch[1]) : 9999;
                    
                    allSuccessItems.push({
                        host: host,
                        port: port,
                        coloName: coloName,
                        delay: delay
                    });
                }
            }
        });
        
        if (allSuccessItems.length === 0) {
            showStatus('æ²¡æœ‰æµ‹è¯•æˆåŠŸçš„æ•°æ®', 'error');
            return;
        }
        
        // æŒ‰å»¶è¿Ÿé€’å¢æ’åº
        allSuccessItems.sort((a, b) => a.delay - b.delay);
        
        // åˆ›å»ºä¸‹è½½çš„txtæ–‡ä»¶å†…å®¹
        const timestamp = new Date().toISOString().split('T')[0];
        let txtContent = '';
        
        // æ·»åŠ æ¯ä¸ªé¡¹ç›®çš„è¯¦ç»†ä¿¡æ¯
        allSuccessItems.forEach(item => {
            txtContent += `${item.host}:${item.port}#${item.coloName} ${item.delay}ms\n`;
        });
        
        // ä¸‹è½½æ–‡ä»¶
        const filename = `å…¨éƒ¨ä¼˜é€‰IP_${timestamp}_${allSuccessItems.length}é¡¹.txt`;
        downloadTextFile(filename, txtContent);
        
        showStatus(`å·²å¯¼å‡ºå…¨éƒ¨ ${allSuccessItems.length} é¡¹æˆåŠŸæ•°æ®ï¼Œå·²æŒ‰å»¶è¿Ÿæ’åº`, 'success');
    });
}

function ipToHex(ip) {
    const parts = ip.split('.');
    if (parts.length !== 4) return null;
    let hex = '';
    for (let i = 0; i < 4; i++) {
        const num = parseInt(parts[i]);
        if (isNaN(num) || num < 0 || num > 255) return null;
        hex += num.toString(16).padStart(2, '0');
    }
    return hex;
}
                const coloMap = {
                    'SJC': 'ğŸ‡ºğŸ‡¸ åœ£ä½•å¡', 'LAX': 'ğŸ‡ºğŸ‡¸ æ´›æ‰çŸ¶', 'SEA': 'ğŸ‡ºğŸ‡¸ è¥¿é›…å›¾', 'SFO': 'ğŸ‡ºğŸ‡¸ æ—§é‡‘å±±', 'DFW': 'ğŸ‡ºğŸ‡¸ è¾¾æ‹‰æ–¯',
                    'ORD': 'ğŸ‡ºğŸ‡¸ èŠåŠ å“¥', 'IAD': 'ğŸ‡ºğŸ‡¸ åç››é¡¿', 'ATL': 'ğŸ‡ºğŸ‡¸ äºšç‰¹å…°å¤§', 'MIA': 'ğŸ‡ºğŸ‡¸ è¿ˆé˜¿å¯†', 'DEN': 'ğŸ‡ºğŸ‡¸ ä¸¹ä½›',
                    'PHX': 'ğŸ‡ºğŸ‡¸ å‡¤å‡°åŸ', 'BOS': 'ğŸ‡ºğŸ‡¸ æ³¢å£«é¡¿', 'EWR': 'ğŸ‡ºğŸ‡¸ çº½ç“¦å…‹', 'JFK': 'ğŸ‡ºğŸ‡¸ çº½çº¦', 'LAS': 'ğŸ‡ºğŸ‡¸ æ‹‰æ–¯ç»´åŠ æ–¯',
                    'MSP': 'ğŸ‡ºğŸ‡¸ æ˜å°¼é˜¿æ³¢åˆ©æ–¯', 'DTW': 'ğŸ‡ºğŸ‡¸ åº•ç‰¹å¾‹', 'PHL': 'ğŸ‡ºğŸ‡¸ è´¹åŸ', 'CLT': 'ğŸ‡ºğŸ‡¸ å¤æ´›ç‰¹', 'SLC': 'ğŸ‡ºğŸ‡¸ ç›æ¹–åŸ',
                    'PDX': 'ğŸ‡ºğŸ‡¸ æ³¢ç‰¹å…°', 'SAN': 'ğŸ‡ºğŸ‡¸ åœ£åœ°äºšå“¥', 'TPA': 'ğŸ‡ºğŸ‡¸ å¦å¸•', 'IAH': 'ğŸ‡ºğŸ‡¸ ä¼‘æ–¯é¡¿', 'MCO': 'ğŸ‡ºğŸ‡¸ å¥¥å…°å¤š',
                    'AUS': 'ğŸ‡ºğŸ‡¸ å¥¥æ–¯æ±€', 'BNA': 'ğŸ‡ºğŸ‡¸ çº³ä»€ç»´å°”', 'RDU': 'ğŸ‡ºğŸ‡¸ ç½—åˆ©', 'IND': 'ğŸ‡ºğŸ‡¸ å°ç¬¬å®‰çº³æ³¢åˆ©æ–¯', 'CMH': 'ğŸ‡ºğŸ‡¸ å“¥ä¼¦å¸ƒ',
                    'MCI': 'ğŸ‡ºğŸ‡¸ å ªè¨æ–¯åŸ', 'OMA': 'ğŸ‡ºğŸ‡¸ å¥¥é©¬å“ˆ', 'ABQ': 'ğŸ‡ºğŸ‡¸ é˜¿å°”ä¼¯å…‹åŸº', 'OKC': 'ğŸ‡ºğŸ‡¸ ä¿„å…‹æ‹‰è·é©¬åŸ', 'MEM': 'ğŸ‡ºğŸ‡¸ å­Ÿè²æ–¯',
                    'JAX': 'ğŸ‡ºğŸ‡¸ æ°å…‹é€Šç»´å°”', 'RIC': 'ğŸ‡ºğŸ‡¸ é‡Œå£«æ»¡', 'BUF': 'ğŸ‡ºğŸ‡¸ å¸ƒæ³•ç½—', 'PIT': 'ğŸ‡ºğŸ‡¸ åŒ¹å…¹å ¡', 'CLE': 'ğŸ‡ºğŸ‡¸ å…‹åˆ©å¤«å…°',
                    'CVG': 'ğŸ‡ºğŸ‡¸ è¾›è¾›é‚£æ', 'MKE': 'ğŸ‡ºğŸ‡¸ å¯†å°”æ²ƒåŸº', 'STL': 'ğŸ‡ºğŸ‡¸ åœ£è·¯æ˜“æ–¯', 'SAT': 'ğŸ‡ºğŸ‡¸ åœ£å®‰ä¸œå°¼å¥¥', 'HNL': 'ğŸ‡ºğŸ‡¸ æª€é¦™å±±',
                    'ANC': 'ğŸ‡ºğŸ‡¸ å®‰å…‹é›·å¥‡', 'SMF': 'ğŸ‡ºğŸ‡¸ è¨å…‹æ‹‰é—¨æ‰˜', 'ONT': 'ğŸ‡ºğŸ‡¸ å®‰å¤§ç•¥', 'OAK': 'ğŸ‡ºğŸ‡¸ å¥¥å…‹å…°',
                    'HKG': 'ğŸ‡­ğŸ‡° é¦™æ¸¯', 'TPE': 'ğŸ‡¹ğŸ‡¼ å°åŒ—', 'TSA': 'ğŸ‡¹ğŸ‡¼ å°åŒ—æ¾å±±', 'KHH': 'ğŸ‡¹ğŸ‡¼ é«˜é›„',
                    'NRT': 'ğŸ‡¯ğŸ‡µ ä¸œäº¬æˆç”°', 'HND': 'ğŸ‡¯ğŸ‡µ ä¸œäº¬ç¾½ç”°', 'KIX': 'ğŸ‡¯ğŸ‡µ å¤§é˜ªå…³è¥¿', 'ITM': 'ğŸ‡¯ğŸ‡µ å¤§é˜ªä¼Šä¸¹', 'NGO': 'ğŸ‡¯ğŸ‡µ åå¤å±‹',
                    'FUK': 'ğŸ‡¯ğŸ‡µ ç¦å†ˆ', 'CTS': 'ğŸ‡¯ğŸ‡µ æœ­å¹Œ', 'OKA': 'ğŸ‡¯ğŸ‡µ å†²ç»³',
                    'ICN': 'ğŸ‡°ğŸ‡· é¦–å°”ä»å·', 'GMP': 'ğŸ‡°ğŸ‡· é¦–å°”é‡‘æµ¦', 'PUS': 'ğŸ‡°ğŸ‡· é‡œå±±',
                    'SIN': 'ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡', 'BKK': 'ğŸ‡¹ğŸ‡­ æ›¼è°·', 'DMK': 'ğŸ‡¹ğŸ‡­ æ›¼è°·å»Šæ›¼', 'KUL': 'ğŸ‡²ğŸ‡¾ å‰éš†å¡', 'CGK': 'ğŸ‡®ğŸ‡© é›…åŠ è¾¾',
                    'MNL': 'ğŸ‡µğŸ‡­ é©¬å°¼æ‹‰', 'CEB': 'ğŸ‡µğŸ‡­ å®¿åŠ¡', 'HAN': 'ğŸ‡»ğŸ‡³ æ²³å†…', 'SGN': 'ğŸ‡»ğŸ‡³ èƒ¡å¿—æ˜', 'DAD': 'ğŸ‡»ğŸ‡³ å²˜æ¸¯',
                    'RGN': 'ğŸ‡²ğŸ‡² ä»°å…‰', 'PNH': 'ğŸ‡°ğŸ‡­ é‡‘è¾¹', 'REP': 'ğŸ‡°ğŸ‡­ æš¹ç²’', 'VTE': 'ğŸ‡±ğŸ‡¦ ä¸‡è±¡',
                    'BOM': 'ğŸ‡®ğŸ‡³ å­Ÿä¹°', 'DEL': 'ğŸ‡®ğŸ‡³ æ–°å¾·é‡Œ', 'MAA': 'ğŸ‡®ğŸ‡³ é‡‘å¥ˆ', 'BLR': 'ğŸ‡®ğŸ‡³ ç­åŠ ç½—å°”', 'CCU': 'ğŸ‡®ğŸ‡³ åŠ å°”å„ç­”',
                    'HYD': 'ğŸ‡®ğŸ‡³ æµ·å¾—æ‹‰å·´', 'AMD': 'ğŸ‡®ğŸ‡³ è‰¾å“ˆè¿ˆè¾¾å·´å¾·', 'COK': 'ğŸ‡®ğŸ‡³ ç§‘é’¦', 'PNQ': 'ğŸ‡®ğŸ‡³ æµ¦é‚£', 'GOI': 'ğŸ‡®ğŸ‡³ æœé˜¿',
                    'CMB': 'ğŸ‡±ğŸ‡° ç§‘ä¼¦å¡', 'DAC': 'ğŸ‡§ğŸ‡© è¾¾å¡', 'KTM': 'ğŸ‡³ğŸ‡µ åŠ å¾·æ»¡éƒ½', 'ISB': 'ğŸ‡µğŸ‡° ä¼Šæ–¯å…°å ¡', 'KHI': 'ğŸ‡µğŸ‡° å¡æ‹‰å¥‡', 'LHE': 'ğŸ‡µğŸ‡° æ‹‰åˆå°”',
                    'LHR': 'ğŸ‡¬ğŸ‡§ ä¼¦æ•¦å¸Œæ€ç½—', 'LGW': 'ğŸ‡¬ğŸ‡§ ä¼¦æ•¦ç›–ç‰¹å¨å…‹', 'STN': 'ğŸ‡¬ğŸ‡§ ä¼¦æ•¦æ–¯å¦æ–¯ç‰¹å¾·', 'LTN': 'ğŸ‡¬ğŸ‡§ ä¼¦æ•¦å¢é¡¿', 'MAN': 'ğŸ‡¬ğŸ‡§ æ›¼å½»æ–¯ç‰¹', 'EDI': 'ğŸ‡¬ğŸ‡§ çˆ±ä¸å ¡', 'BHX': 'ğŸ‡¬ğŸ‡§ ä¼¯æ˜ç¿°',
                    'CDG': 'ğŸ‡«ğŸ‡· å·´é»æˆ´é«˜ä¹', 'ORY': 'ğŸ‡«ğŸ‡· å·´é»å¥¥åˆ©', 'MRS': 'ğŸ‡«ğŸ‡· é©¬èµ›', 'LYS': 'ğŸ‡«ğŸ‡· é‡Œæ˜‚', 'NCE': 'ğŸ‡«ğŸ‡· å°¼æ–¯',
                    'FRA': 'ğŸ‡©ğŸ‡ª æ³•å…°å…‹ç¦', 'MUC': 'ğŸ‡©ğŸ‡ª æ…•å°¼é»‘', 'TXL': 'ğŸ‡©ğŸ‡ª æŸæ—', 'BER': 'ğŸ‡©ğŸ‡ª æŸæ—å‹ƒå…°ç™»å ¡', 'HAM': 'ğŸ‡©ğŸ‡ª æ±‰å ¡', 'DUS': 'ğŸ‡©ğŸ‡ª æœå¡å°”å¤šå¤«', 'CGN': 'ğŸ‡©ğŸ‡ª ç§‘éš†', 'STR': 'ğŸ‡©ğŸ‡ª æ–¯å›¾åŠ ç‰¹',
                    'AMS': 'ğŸ‡³ğŸ‡± é˜¿å§†æ–¯ç‰¹ä¸¹', 'BRU': 'ğŸ‡§ğŸ‡ª å¸ƒé²å¡å°”', 'LUX': 'ğŸ‡±ğŸ‡º å¢æ£®å ¡',
                    'ZRH': 'ğŸ‡¨ğŸ‡­ è‹é»ä¸–', 'GVA': 'ğŸ‡¨ğŸ‡­ æ—¥å†…ç“¦', 'BSL': 'ğŸ‡¨ğŸ‡­ å·´å¡å°”',
                    'VIE': 'ğŸ‡¦ğŸ‡¹ ç»´ä¹Ÿçº³', 'PRG': 'ğŸ‡¨ğŸ‡¿ å¸ƒæ‹‰æ ¼', 'BUD': 'ğŸ‡­ğŸ‡º å¸ƒè¾¾ä½©æ–¯', 'WAW': 'ğŸ‡µğŸ‡± åæ²™', 'KRK': 'ğŸ‡µğŸ‡± å…‹æ‹‰ç§‘å¤«',
                    'MXP': 'ğŸ‡®ğŸ‡¹ ç±³å…°é©¬å°”å½­è¨', 'LIN': 'ğŸ‡®ğŸ‡¹ ç±³å…°åˆ©çº³ç‰¹', 'FCO': 'ğŸ‡®ğŸ‡¹ ç½—é©¬', 'VCE': 'ğŸ‡®ğŸ‡¹ å¨å°¼æ–¯', 'NAP': 'ğŸ‡®ğŸ‡¹ é‚£ä¸å‹’æ–¯', 'FLR': 'ğŸ‡®ğŸ‡¹ ä½›ç½—ä¼¦è¨', 'BGY': 'ğŸ‡®ğŸ‡¹ è´åŠ è«',
                    'MAD': 'ğŸ‡ªğŸ‡¸ é©¬å¾·é‡Œ', 'BCN': 'ğŸ‡ªğŸ‡¸ å·´å¡ç½—é‚£', 'PMI': 'ğŸ‡ªğŸ‡¸ å¸•å°”é©¬', 'AGP': 'ğŸ‡ªğŸ‡¸ é©¬æ‹‰åŠ ', 'VLC': 'ğŸ‡ªğŸ‡¸ ç“¦ä¼¦è¥¿äºš', 'SVQ': 'ğŸ‡ªğŸ‡¸ å¡ç»´åˆ©äºš', 'BIO': 'ğŸ‡ªğŸ‡¸ æ¯•å°”å·´é„‚',
                    'LIS': 'ğŸ‡µğŸ‡¹ é‡Œæ–¯æœ¬', 'OPO': 'ğŸ‡µğŸ‡¹ æ³¢å°”å›¾', 'FAO': 'ğŸ‡µğŸ‡¹ æ³•é²',
                    'DUB': 'ğŸ‡®ğŸ‡ª éƒ½æŸæ—', 'CPH': 'ğŸ‡©ğŸ‡° å“¥æœ¬å“ˆæ ¹', 'ARN': 'ğŸ‡¸ğŸ‡ª æ–¯å¾·å“¥å°”æ‘©', 'GOT': 'ğŸ‡¸ğŸ‡ª å“¥å¾·å ¡',
                    'OSL': 'ğŸ‡³ğŸ‡´ å¥¥æ–¯é™†', 'BGO': 'ğŸ‡³ğŸ‡´ å‘å°”æ ¹', 'HEL': 'ğŸ‡«ğŸ‡® èµ«å°”è¾›åŸº', 'RIX': 'ğŸ‡±ğŸ‡» é‡ŒåŠ ', 'TLL': 'ğŸ‡ªğŸ‡ª å¡”æ—', 'VNO': 'ğŸ‡±ğŸ‡¹ ç»´å°”çº½æ–¯',
                    'ATH': 'ğŸ‡¬ğŸ‡· é›…å…¸', 'SKG': 'ğŸ‡¬ğŸ‡· å¡è¨æ´›å°¼åŸº', 'SOF': 'ğŸ‡§ğŸ‡¬ ç´¢éäºš', 'OTP': 'ğŸ‡·ğŸ‡´ å¸ƒåŠ å‹’æ–¯ç‰¹', 'BEG': 'ğŸ‡·ğŸ‡¸ è´å°”æ ¼è±å¾·', 'ZAG': 'ğŸ‡­ğŸ‡· è¨æ ¼å‹’å¸ƒ', 'LJU': 'ğŸ‡¸ğŸ‡® å¢å¸ƒå°”é›…é‚£',
                    'KBP': 'ğŸ‡ºğŸ‡¦ åŸºè¾…', 'IEV': 'ğŸ‡ºğŸ‡¦ åŸºè¾…èŒ¹è‰¯å°¼', 'ODS': 'ğŸ‡ºğŸ‡¦ æ•–å¾·è¨',
                    'SVO': 'ğŸ‡·ğŸ‡º è«æ–¯ç§‘è°¢åˆ—æ¢…æ·æ²ƒ', 'DME': 'ğŸ‡·ğŸ‡º è«æ–¯ç§‘å¤šè«æ°å¤šæ²ƒ', 'VKO': 'ğŸ‡·ğŸ‡º è«æ–¯ç§‘ä¼åŠªç§‘æ²ƒ', 'LED': 'ğŸ‡·ğŸ‡º åœ£å½¼å¾—å ¡',
                    'IST': 'ğŸ‡¹ğŸ‡· ä¼Šæ–¯å¦å¸ƒå°”', 'SAW': 'ğŸ‡¹ğŸ‡· ä¼Šæ–¯å¦å¸ƒå°”è¨æ¯”å“ˆ', 'ESB': 'ğŸ‡¹ğŸ‡· å®‰å¡æ‹‰', 'AYT': 'ğŸ‡¹ğŸ‡· å®‰å¡”åˆ©äºš', 'ADB': 'ğŸ‡¹ğŸ‡· ä¼Šå…¹å¯†å°”',
                    'TLV': 'ğŸ‡®ğŸ‡± ç‰¹æ‹‰ç»´å¤«', 'AMM': 'ğŸ‡¯ğŸ‡´ å®‰æ›¼', 'BEY': 'ğŸ‡±ğŸ‡§ è´é²ç‰¹', 'BAH': 'ğŸ‡§ğŸ‡­ å·´æ—', 'KWI': 'ğŸ‡°ğŸ‡¼ ç§‘å¨ç‰¹',
                    'DXB': 'ğŸ‡¦ğŸ‡ª è¿ªæ‹œ', 'AUH': 'ğŸ‡¦ğŸ‡ª é˜¿å¸ƒæ‰æ¯”', 'SHJ': 'ğŸ‡¦ğŸ‡ª æ²™è¿¦', 'DOH': 'ğŸ‡¶ğŸ‡¦ å¤šå“ˆ', 'MCT': 'ğŸ‡´ğŸ‡² é©¬æ–¯å–€ç‰¹',
                    'RUH': 'ğŸ‡¸ğŸ‡¦ åˆ©é›…å¾—', 'JED': 'ğŸ‡¸ğŸ‡¦ å‰è¾¾', 'DMM': 'ğŸ‡¸ğŸ‡¦ è¾¾æ›¼',
                    'CAI': 'ğŸ‡ªğŸ‡¬ å¼€ç½—', 'HBE': 'ğŸ‡ªğŸ‡¬ äºšå†å±±å¤§', 'SSH': 'ğŸ‡ªğŸ‡¬ æ²™å§†æ²™ä¼Šèµ«',
                    'CMN': 'ğŸ‡²ğŸ‡¦ å¡è¨å¸ƒå…°å¡', 'RAK': 'ğŸ‡²ğŸ‡¦ é©¬æ‹‰å–€ä»€', 'TUN': 'ğŸ‡¹ğŸ‡³ çªå°¼æ–¯', 'ALG': 'ğŸ‡©ğŸ‡¿ é˜¿å°”åŠå°”',
                    'LOS': 'ğŸ‡³ğŸ‡¬ æ‹‰å„æ–¯', 'ABV': 'ğŸ‡³ğŸ‡¬ é˜¿å¸ƒè´¾', 'ACC': 'ğŸ‡¬ğŸ‡­ é˜¿å…‹æ‹‰', 'NBO': 'ğŸ‡°ğŸ‡ª å†…ç½—æ¯•', 'MBA': 'ğŸ‡°ğŸ‡ª è’™å·´è¨', 'ADD': 'ğŸ‡ªğŸ‡¹ äºšçš„æ–¯äºšè´å·´', 'DAR': 'ğŸ‡¹ğŸ‡¿ è¾¾ç´¯æ–¯è¨æ‹‰å§†',
                    'JNB': 'ğŸ‡¿ğŸ‡¦ çº¦ç¿°å†…æ–¯å ¡', 'CPT': 'ğŸ‡¿ğŸ‡¦ å¼€æ™®æ•¦', 'DUR': 'ğŸ‡¿ğŸ‡¦ å¾·ç­', 'HRE': 'ğŸ‡¿ğŸ‡¼ å“ˆæ‹‰é›·', 'LUN': 'ğŸ‡¿ğŸ‡² å¢è¨å¡',
                    'MRU': 'ğŸ‡²ğŸ‡º æ¯›é‡Œæ±‚æ–¯', 'SEZ': 'ğŸ‡¸ğŸ‡¨ å¡èˆŒå°”',
                    'SYD': 'ğŸ‡¦ğŸ‡º æ‚‰å°¼', 'MEL': 'ğŸ‡¦ğŸ‡º å¢¨å°”æœ¬', 'BNE': 'ğŸ‡¦ğŸ‡º å¸ƒé‡Œæ–¯ç­', 'PER': 'ğŸ‡¦ğŸ‡º ç€æ–¯', 'ADL': 'ğŸ‡¦ğŸ‡º é˜¿å¾·è±å¾·', 'CBR': 'ğŸ‡¦ğŸ‡º å ªåŸ¹æ‹‰', 'OOL': 'ğŸ‡¦ğŸ‡º é»„é‡‘æµ·å²¸', 'CNS': 'ğŸ‡¦ğŸ‡º å‡¯æ©æ–¯',
                    'AKL': 'ğŸ‡³ğŸ‡¿ å¥¥å…‹å…°', 'WLG': 'ğŸ‡³ğŸ‡¿ æƒ çµé¡¿', 'CHC': 'ğŸ‡³ğŸ‡¿ åŸºç£åŸ', 'ZQN': 'ğŸ‡³ğŸ‡¿ çš‡åé•‡',
                    'NAN': 'ğŸ‡«ğŸ‡¯ æ¥ è¿ª', 'PPT': 'ğŸ‡µğŸ‡« å¸•çš®æ', 'GUM': 'ğŸ‡¬ğŸ‡º å…³å²›',
                    'GRU': 'ğŸ‡§ğŸ‡· åœ£ä¿ç½—ç“œé²æŸ³æ–¯', 'CGH': 'ğŸ‡§ğŸ‡· åœ£ä¿ç½—å­”æˆˆå°¼äºšæ–¯', 'GIG': 'ğŸ‡§ğŸ‡· é‡Œçº¦çƒ­å†…å¢', 'BSB': 'ğŸ‡§ğŸ‡· å·´è¥¿åˆ©äºš', 'CNF': 'ğŸ‡§ğŸ‡· è´æ´›å¥¥é‡Œè—ç‰¹', 'POA': 'ğŸ‡§ğŸ‡· é˜¿é›·æ ¼é‡Œæ¸¯', 'CWB': 'ğŸ‡§ğŸ‡· åº“é‡Œè’‚å·´', 'FOR': 'ğŸ‡§ğŸ‡· ç¦å¡”è±è¨', 'REC': 'ğŸ‡§ğŸ‡· ç´¯è¥¿è…“', 'SSA': 'ğŸ‡§ğŸ‡· è¨å°”ç“¦å¤š',
                    'EZE': 'ğŸ‡¦ğŸ‡· å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯', 'AEP': 'ğŸ‡¦ğŸ‡· å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯åŸ', 'COR': 'ğŸ‡¦ğŸ‡· ç§‘å°”å¤šç“¦', 'MDZ': 'ğŸ‡¦ğŸ‡· é—¨å¤šè¨',
                    'SCL': 'ğŸ‡¨ğŸ‡± åœ£åœ°äºšå“¥', 'LIM': 'ğŸ‡µğŸ‡ª åˆ©é©¬', 'BOG': 'ğŸ‡¨ğŸ‡´ æ³¢å“¥å¤§', 'MDE': 'ğŸ‡¨ğŸ‡´ éº¦å¾·æ—', 'CLO': 'ğŸ‡¨ğŸ‡´ å¡åˆ©',
                    'UIO': 'ğŸ‡ªğŸ‡¨ åŸºå¤š', 'GYE': 'ğŸ‡ªğŸ‡¨ ç“œäºšåŸºå°”', 'CCS': 'ğŸ‡»ğŸ‡ª åŠ æ‹‰åŠ æ–¯', 'MVD': 'ğŸ‡ºğŸ‡¾ è’™å¾—ç»´çš„äºš', 'ASU': 'ğŸ‡µğŸ‡¾ äºšæ¾æ£®',
                    'PTY': 'ğŸ‡µğŸ‡¦ å·´æ‹¿é©¬åŸ', 'SJO': 'ğŸ‡¨ğŸ‡· åœ£ä½•å¡', 'GUA': 'ğŸ‡¬ğŸ‡¹ å±åœ°é©¬æ‹‰åŸ', 'SAL': 'ğŸ‡¸ğŸ‡» åœ£è¨å°”ç“¦å¤š', 'TGU': 'ğŸ‡­ğŸ‡³ ç‰¹å¤è¥¿åŠ å°”å·´', 'MGA': 'ğŸ‡³ğŸ‡® é©¬é‚£ç“œ', 'BZE': 'ğŸ‡§ğŸ‡¿ ä¼¯åˆ©å…¹åŸ',
                    'MEX': 'ğŸ‡²ğŸ‡½ å¢¨è¥¿å“¥åŸ', 'GDL': 'ğŸ‡²ğŸ‡½ ç“œè¾¾æ‹‰å“ˆæ‹‰', 'MTY': 'ğŸ‡²ğŸ‡½ è’™ç‰¹é›·', 'CUN': 'ğŸ‡²ğŸ‡½ åæ˜†', 'TIJ': 'ğŸ‡²ğŸ‡½ è’‚åçº³', 'SJD': 'ğŸ‡²ğŸ‡½ åœ£ä½•å¡å¾·å°”å¡æ²ƒ',
                    'YYZ': 'ğŸ‡¨ğŸ‡¦ å¤šä¼¦å¤š', 'YVR': 'ğŸ‡¨ğŸ‡¦ æ¸©å“¥å', 'YUL': 'ğŸ‡¨ğŸ‡¦ è’™ç‰¹åˆ©å°”', 'YYC': 'ğŸ‡¨ğŸ‡¦ å¡å°”åŠ é‡Œ', 'YEG': 'ğŸ‡¨ğŸ‡¦ åŸƒå¾·è’™é¡¿', 'YOW': 'ğŸ‡¨ğŸ‡¦ æ¸¥å¤ªå', 'YWG': 'ğŸ‡¨ğŸ‡¦ æ¸©å°¼ä¼¯', 'YHZ': 'ğŸ‡¨ğŸ‡¦ å“ˆåˆ©æ³•å…‹æ–¯',
                    'HAV': 'ğŸ‡¨ğŸ‡º å“ˆç“¦é‚£', 'SJU': 'ğŸ‡µğŸ‡· åœ£èƒ¡å®‰', 'SDQ': 'ğŸ‡©ğŸ‡´ åœ£å¤šæ˜å„', 'PAP': 'ğŸ‡­ğŸ‡¹ å¤ªå­æ¸¯', 'KIN': 'ğŸ‡¯ğŸ‡² é‡‘æ–¯é¡¿', 'NAS': 'ğŸ‡§ğŸ‡¸ æ‹¿éªš', 'MBJ': 'ğŸ‡¯ğŸ‡² è’™ç‰¹å“¥è´'
                };
                function getColoName(colo) {
                    return coloMap[colo] || colo;
                }

                // åŸå¸‚ç­›é€‰ç›¸å…³å‡½æ•°
                const cityFilterContainer = document.getElementById('cityFilterContainer');
                const cityCheckboxesContainer = document.getElementById('cityCheckboxesContainer');

                function updateCityFilter() {
                    if (!cityFilterContainer || !cityCheckboxesContainer) return;

                    // ä»æµ‹è¯•ç»“æœä¸­æå–æ‰€æœ‰å¯ç”¨çš„åŸå¸‚
                    const cityMap = new Map();
                    testResults.forEach((result, index) => {
                        if (result.success && result.colo) {
                            const colo = result.colo;
                            if (!cityMap.has(colo)) {
                                cityMap.set(colo, {
                                    colo: colo,
                                    name: getColoName(colo),
                                    count: 0
                                });
                            }
                            cityMap.get(colo).count++;
                        }
                    });

                    if (cityMap.size === 0) {
                        cityFilterContainer.style.display = 'none';
                        return;
                    }

                    cityFilterContainer.style.display = 'block';
                    cityCheckboxesContainer.innerHTML = '';

                    // æŒ‰åŸå¸‚åç§°æ’åº
                    const cities = Array.from(cityMap.values()).sort((a, b) => a.name.localeCompare(b.name));

                    cities.forEach(city => {
                        const label = document.createElement('label');
                        label.style.cssText = 'display: inline-flex; align-items: center; cursor: pointer; color: #00ff00; font-size: 0.85rem; padding: 4px 8px; background: rgba(0, 40, 0, 0.4); border: 1px solid #00aa00; border-radius: 4px;';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = city.colo;
                        checkbox.checked = true;
                        checkbox.dataset.colo = city.colo;
                        checkbox.style.cssText = 'margin-right: 6px; width: 16px; height: 16px; cursor: pointer;';

                        const span = document.createElement('span');
                        span.textContent = city.name + ' (' + city.count + ')';

                        label.appendChild(checkbox);
                        label.appendChild(span);
                        cityCheckboxesContainer.appendChild(label);

                        checkbox.addEventListener('change', filterResultsByCity);
                    });

                    // ç›‘å¬ç­›é€‰æ¨¡å¼å˜åŒ–
                    const filterModeRadios = document.querySelectorAll('input[name="cityFilterMode"]');
                    filterModeRadios.forEach(radio => {
                        radio.addEventListener('change', function() {
                            if (this.value === 'all') {
                                // åˆ‡æ¢åˆ°"å…¨éƒ¨åŸå¸‚"æ¨¡å¼æ—¶ï¼Œè‡ªåŠ¨é€‰ä¸­æ‰€æœ‰åŸå¸‚å¤é€‰æ¡†
                                const cityCheckboxes = cityCheckboxesContainer.querySelectorAll('input[type="checkbox"]');
                                cityCheckboxes.forEach(cb => {
                                    cb.checked = true;
                                    cb.disabled = false;
                                });
                            }
                            filterResultsByCity();
                        });
                    });
                }

                function filterResultsByCity() {
                    if (!resultsList || !cityCheckboxesContainer) return;

                    const filterMode = document.querySelector('input[name="cityFilterMode"]:checked')?.value || 'all';
                    const resultItems = resultsList.querySelectorAll('[data-index]');
                    const cityCheckboxes = cityCheckboxesContainer.querySelectorAll('input[type="checkbox"]');

                    if (filterMode === 'fastest10') {
                        // åªé€‰æ‹©æœ€å¿«çš„10ä¸ª
                        const sortedResults = testResults
                            .map((result, index) => ({ result, index }))
                            .filter(item => item.result.success)
                            .sort((a, b) => a.result.latency - b.result.latency)
                            .slice(0, 10);

                        const fastestIndices = new Set(sortedResults.map(item => item.index));

                        resultItems.forEach(item => {
                            const index = parseInt(item.dataset.index);
                            const checkbox = item.querySelector('input[type="checkbox"]');
                            if (fastestIndices.has(index)) {
                                item.style.display = 'flex';
                                if (checkbox) checkbox.checked = true;
                            } else {
                                item.style.display = 'none';
                                if (checkbox) checkbox.checked = false;
                            }
                        });

                        // ç¦ç”¨åŸå¸‚å¤é€‰æ¡†
                        cityCheckboxes.forEach(cb => cb.disabled = true);
                    } else {
                        // æ ¹æ®é€‰ä¸­çš„åŸå¸‚ç­›é€‰
                        const selectedCities = new Set();
                        cityCheckboxes.forEach(cb => {
                            if (cb.checked) {
                                selectedCities.add(cb.value);
                            }
                        });

                        // å¦‚æœæ‰€æœ‰åŸå¸‚éƒ½è¢«é€‰ä¸­ï¼ˆæˆ–æ²¡æœ‰é€‰ä¸­ä»»ä½•åŸå¸‚ï¼‰ï¼Œæ˜¾ç¤ºæ‰€æœ‰ç»“æœ
                        const allChecked = cityCheckboxes.length > 0 && selectedCities.size === cityCheckboxes.length;
                        const noneChecked = selectedCities.size === 0;

                        resultItems.forEach(item => {
                            const colo = item.dataset.colo || '';
                            const checkbox = item.querySelector('input[type="checkbox"]');
                            if (allChecked || noneChecked || selectedCities.has(colo)) {
                                item.style.display = 'flex';
                                // åŒæ­¥æ›´æ–°ç»“æœé¡¹å¤é€‰æ¡†çš„é€‰ä¸­çŠ¶æ€
                                if (checkbox) {
                                    if (allChecked) {
                                        // æ‰€æœ‰åŸå¸‚éƒ½é€‰ä¸­æ—¶ï¼Œæ‰€æœ‰ç»“æœé¡¹å¤é€‰æ¡†éƒ½é€‰ä¸­
                                        checkbox.checked = true;
                                    } else if (noneChecked) {
                                        // æ²¡æœ‰é€‰ä¸­ä»»ä½•åŸå¸‚æ—¶ï¼Œæ‰€æœ‰ç»“æœé¡¹å¤é€‰æ¡†éƒ½å–æ¶ˆé€‰ä¸­
                                        checkbox.checked = false;
                                    } else {
                                        // æ ¹æ®åŸå¸‚é€‰æ‹©çŠ¶æ€åŒæ­¥å¤é€‰æ¡†
                                        checkbox.checked = selectedCities.has(colo);
                                    }
                                }
                            } else {
                                item.style.display = 'none';
                                // å–æ¶ˆé€‰ä¸­éšè—çš„ç»“æœé¡¹å¤é€‰æ¡†
                                if (checkbox) {
                                    checkbox.checked = false;
                                }
                            }
                        });

                        // å¯ç”¨åŸå¸‚å¤é€‰æ¡†
                        cityCheckboxes.forEach(cb => cb.disabled = false);
                    }
                }

                async function testLatency(host, port, signal) {
                    const timeout = 8000;
                    let colo = '';
                    let testUrl = '';

                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeout);

                        if (signal) {
                            signal.addEventListener('abort', () => controller.abort());
                        }

                        const cleanHost = host.replace(/^\[|\]$/g, '');
                        const hexIP = ipToHex(cleanHost);
                        const testDomain = hexIP ? (hexIP + '.nip.lfree.org') : (cleanHost + '.nip.lfree.org');
                        testUrl = 'https://' + testDomain + ':' + port + '/';

                        console.log('[LatencyTest] Testing:', testUrl, 'Original:', host + ':' + port, 'HexIP:', hexIP);

                        const firstStart = Date.now();
                        const response1 = await fetch(testUrl, { 
                            signal: controller.signal
                        });
                        const firstTime = Date.now() - firstStart;

                        if (!response1.ok) {
                            clearTimeout(timeoutId);
                            return { success: false, latency: firstTime, error: 'HTTP ' + response1.status + ' ' + response1.statusText, colo: '', testUrl: testUrl };
                        }

                        try {
                            const text = await response1.text();
                            console.log('[LatencyTest] Response body:', text.substring(0, 200));
                            const data = JSON.parse(text);
                            if (data.colo) {
                                colo = data.colo;
                            }
                        } catch (e) {
                            console.log('[LatencyTest] Parse error:', e.message);
                        }

                        const secondStart = Date.now();
                        const response2 = await fetch(testUrl, { 
                            signal: controller.signal
                        });
                        await response2.text();
                        const latency = Date.now() - secondStart;

                        clearTimeout(timeoutId);

                        console.log('[LatencyTest] First:', firstTime + 'ms (DNS+TLS+RTT)', 'Second:', latency + 'ms (RTT only)');

                        return { success: true, latency: latency, colo: colo, testUrl: testUrl };
                    } catch (error) {
                        const errorMsg = error.name === 'AbortError' ? 'è¶…æ—¶' : error.message;
                        console.log('[LatencyTest] Error:', errorMsg, 'URL:', testUrl);
                        return { success: false, latency: -1, error: errorMsg, colo: '', testUrl: testUrl };
                    }
                }
            });
        </script>
    </body>
    </html>
